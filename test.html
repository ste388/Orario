<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>App Firebase Pronta (Auto-login)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:#0b1220;color:#e7e9ee}
    header{padding:12px 16px;border-bottom:1px solid #1f2a44;background:#0f1730}
    main{padding:16px;max-width:920px;margin:0 auto}
    #init-overlay{position:fixed;inset:0;background:#0b1220;display:flex;align-items:center;justify-content:center;z-index:1000}
    .card{background:#121a33;border:1px solid #1f2a44;border-radius:10px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,button,textarea{background:#0f1730;border:1px solid #2a3a69;color:#e7e9ee;border-radius:8px;padding:10px;font-size:14px}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #203059;padding:8px;text-align:left}
    .muted{color:#9aa3b2;font-size:13px}
    .ok{color:#56d364}
    .warn{color:#f2cc60}
    .err{color:#ff6b6b}
    .right{margin-left:auto}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div id="init-overlay">Inizializzazione del sistema...</div>

  <header class="row">
    <div>App Firebase Pronta</div>
    <div class="right muted" id="env"></div>
  </header>

  <main>
    <div class="card">
      <div class="row">
        <span id="auth-state" class="muted">Utente: in attesa…</span>
        <span id="sync-status" class="muted right" hidden>Sincronizzazione…</span>
      </div>
      <div id="alerts" class="muted small"></div>
    </div>

    <div class="card">
      <h3>Nuovo elemento</h3>
      <div class="row">
        <input id="item-title" placeholder="Titolo">
        <textarea id="item-notes" rows="2" placeholder="Note opzionali"></textarea>
        <button id="btn-save">Salva</button>
      </div>
    </div>

    <div class="card">
      <h3>Elementi</h3>
      <table>
        <thead><tr><th>Titolo</th><th>Note</th><th>Azioni</th></tr></thead>
        <tbody id="items-body"></tbody>
      </table>
    </div>
  </main>

  <!-- Firebase v10+ (modular) via CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInAnonymously,
      connectAuthEmulator
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      onSnapshot, query, where, orderBy, enableIndexedDbPersistence,
      doc, deleteDoc, connectFirestoreEmulator
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Config locale "dummy": non serve modificare
    const firebaseConfig = { apiKey: "demo-key", authDomain: "demo-local", projectId: "demo-test", appId: "demo-app" };

    // Utility UI
    const $ = s => document.querySelector(s);
    const hide = el => el && (el.hidden = true);
    const show = el => el && (el.hidden = false);
    const setText = (sel, txt) => { const el = typeof sel==='string' ? $(sel) : sel; if (el) el.textContent = txt; };
    function showAlert(msg, cls='muted'){ const el = $('#alerts'); const ts = new Date().toLocaleTimeString(); el.innerHTML = `<div class="${cls}">[${ts}] ${msg}</div>` + el.innerHTML; }

    // Overlay e stato sync
    const overlay = $('#init-overlay');
    const syncEl = $('#sync-status');
    const closeOverlay = () => { if (overlay) overlay.style.display = 'none'; };
    const openSync = (m='Sincronizzazione…') => { if (syncEl){ syncEl.textContent=m; show(syncEl);} };
    const closeSync = () => { hide(syncEl); };

    // Chiudi overlay subito al DOM pronto
    document.addEventListener('DOMContentLoaded', () => { closeOverlay(); openSync('Avvio…'); });

    // Inizializza Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Prova a collegarsi agli emulatori locali se presenti
    try {
      const host = location.hostname;
      connectAuthEmulator(auth, `http://${host}:9099`, { disableWarnings: true });
      connectFirestoreEmulator(db, host, 8080);
      setText('#env', 'Ambiente: emulatori locali');
      showAlert('Connesso agli emulatori (Auth:9099, Firestore:8080)', 'ok');
    } catch(_) {
      setText('#env', 'Ambiente: locale');
    }

    // Abilita cache offline
    enableIndexedDbPersistence(db).catch(err => {
      if (err.code === 'failed-precondition') showAlert('Persistence disattivata (più tab aperte).', 'warn');
      else showAlert('Persistence non disponibile: ' + err.message, 'warn');
    });

    // Login anonimo automatico con retry
    async function ensureAnonLogin(retries = 3){
      for (let i=0;i<retries;i++){
        try { await signInAnonymously(auth); return true; }
        catch(e){ showAlert('Login anonimo fallito: ' + e.message, 'warn'); await new Promise(r=>setTimeout(r, 1000*(i+1))); }
      }
      showAlert('Procedo offline: le operazioni si sincronizzeranno quando disponibili.', 'warn');
      return false;
    }

    // Stato auth
    onAuthStateChanged(auth, (user) => {
      if (user){
        setText('#auth-state', `Utente: ${user.isAnonymous?'anonimo':'autenticato'} (${user.uid.slice(0,6)}…)`);
        subscribeItems(user.uid);
        closeSync();
        showAlert('Sessione attiva', 'ok');
      } else {
        setText('#auth-state', 'Utente: nessuno');
        unsubscribeItems();
      }
    });

    // Avvio
    (async () => {
      await ensureAnonLogin();
      closeOverlay();
      closeSync();
    })();

    // CRUD collegato all'utente
    let itemsUnsub = null;
    function unsubscribeItems(){ if (itemsUnsub){ itemsUnsub(); itemsUnsub=null; } $('#items-body').innerHTML=''; }

    function subscribeItems(uid){
      unsubscribeItems();
      const colRef = collection(db, 'items');
      const q = query(colRef, where('ownerUid','==',uid), orderBy('createdAt','desc'));
      itemsUnsub = onSnapshot(q, (snap)=>{
        const tbody = $('#items-body'); tbody.innerHTML='';
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${(d.title||'').toString().replace(/</g,'&lt;')}</td>
            <td>${(d.notes||'').toString().replace(/</g,'&lt;')}</td>
            <td><button class="btn-del" data-id="${docSnap.id}">Elimina</button></td>`;
          tbody.appendChild(tr);
        });
      }, (err)=>{ showAlert('Errore stream: '+err.message, 'err'); });
    }

    // Salvataggio
    $('#btn-save').addEventListener('click', async ()=>{
      const user = auth.currentUser;
      if (!user) { showAlert('Sessione non pronta, ritento login…', 'warn'); await ensureAnonLogin(); }
      const ready = !!auth.currentUser;
      if (!ready){ showAlert('Non autenticato, riprova tra poco.', 'warn'); return; }

      const title = $('#item-title').value.trim();
      const notes = $('#item-notes').value.trim();
      if (!title){ showAlert('Titolo obbligatorio', 'warn'); return; }

      openSync('Salvataggio…');
      try {
        await addDoc(collection(db, 'items'), { title, notes, ownerUid: auth.currentUser.uid, createdAt: serverTimestamp() });
        $('#item-title').value=''; $('#item-notes').value='';
        showAlert('Elemento salvato', 'ok');
      } catch(e){
        showAlert('Errore salvataggio: '+e.message, 'err');
      } finally {
        closeSync();
      }
    });

    // Eliminazione
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.btn-del');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      if (!id) return;
      openSync('Eliminazione…');
      try { await deleteDoc(doc(db,'items',id)); showAlert('Eliminato','ok'); }
      catch(e){ showAlert('Errore eliminazione: '+e.message, 'err'); }
      finally{ closeSync(); }
    });

    // Fail-safe overlay
    window.addEventListener('error', ()=>closeOverlay());
    window.addEventListener('unhandledrejection', ()=>closeOverlay());
  </script>
</body>
</html>
