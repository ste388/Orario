<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendario Orario Giornaliero</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Stili Base */
    body { font-family: Inter, sans-serif; background-color: #f0f4f8; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 2rem 1rem; }
    .input-cell-wrapper { padding: 0; text-align: center; }
    .time-input { width: 100%; padding: 0.5rem 0.25rem; text-align: center; border: none; background-color: transparent; font-size: 1rem; line-height: 1.25rem; border-radius: 0.375rem; outline: none; transition: background-color 0.2s, box-shadow 0.2s; }
    .time-input:focus { background-color: #e0f2fe; box-shadow: 0 0 0 2px #93c5fd; }
    /* Stile per il placeholder (quando il valore è 0000) - Usiamo una classe per il controllo JS */
    .time-input.italic-placeholder { color: #9ca3af; font-style: italic; } 
    /* Stili Calendario AGGIORNATI per status */
    .calendar-day { transition: all 0.15s ease-in-out; cursor: pointer; user-select: none; height: 48px; display: flex; align-items: center; justify-content: center; color: #374151; font-weight: 500; }
    .calendar-day:hover { background-color: #e0f2fe; transform: scale(1.05);}
    /* Selezionato (priorità massima) */
    .calendar-day.selected { background-color: #3b82f6; color: white; font-weight: bold; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    /* STATI AGGIUNTI PER IL REQUISITO UTENTE */
    .calendar-day.status-partial { 
        background-color: #fde68a; /* Giallo 200 */
        color: #92400e; /* Giallo scuro testo */
        font-weight: 600; 
    }
    .calendar-day.status-complete { 
        background-color: #a7f3d0; /* Verde 200 */
        color: #065f46; /* Verde scuro testo */
        font-weight: 600; 
    }
    /* Se un giorno è selezionato E completo/parziale, usiamo lo stile selected */
    .calendar-day.selected.status-partial, 
    .calendar-day.selected.status-complete {
        background-color: #3b82f6; 
        color: white;
    }
  </style>
</head>
<body>
<div class="w-full max-w-4xl p-6 bg-white shadow-2xl rounded-xl border border-blue-100">
  <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center border-b-2 pb-3 border-blue-200">Orario Giornaliero</h1>
  <div id="status-message" class="text-center text-sm mb-4 p-2 rounded-lg bg-blue-50 text-blue-800">Inizializzazione del sistema...</div>
  
  <!-- Sezione Calendario -->
  <div class="mb-8 p-4 bg-blue-600 text-white rounded-xl shadow-lg">
    <div id="calendar-header" class="flex justify-between items-center mb-4"></div>
    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
  </div>
  
  <!-- Sezione Form Orari -->
  <div id="daily-schedule-form" class="p-6 border border-gray-200 rounded-xl bg-gray-50 shadow-inner">
    <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center">Orario per <span id="selected-date-display" class="text-blue-600">Oggi</span></h2>
    
    <!-- Tabella Input Orari -->
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-300 border border-gray-200 rounded-lg">
        <thead class="bg-blue-100/50">
          <tr>
            <th class="px-3 py-3 text-left text-sm font-medium text-gray-700 w-1/2">Campo Orario</th>
            <th class="px-3 py-3 text-center text-sm font-medium text-gray-700 w-1/2">Valore (HH:MM)</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-3 text-sm font-medium text-gray-900">Entrata Mattina</td>
            <td class="input-cell-wrapper border-l border-r border-gray-200"><input type="text" id="entrataMattina" class="time-input" value="00:00"></td>
          </tr>
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-3 text-sm font-medium text-gray-900">Uscita Pranzo</td>
            <td class="input-cell-wrapper border-l border-r border-gray-200"><input type="text" id="uscitaPranzo" class="time-input" value="00:00"></td>
          </tr>
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-3 text-sm font-medium text-gray-900">Entrata Pomeriggio</td>
            <td class="input-cell-wrapper border-l border-r border-gray-200"><input type="text" id="entrataPomeriggio" class="time-input" value="00:00"></td>
          </tr>
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-3 text-sm font-medium text-gray-900">Uscita Sera</td>
            <td class="input-cell-wrapper border-l border-r border-gray-200"><input type="text" id="uscitaSera" class="time-input" value="00:00"></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Nuova Sezione: Risultati Calcolati -->
    <h3 class="text-xl font-bold text-gray-700 mt-6 mb-3 text-center border-t pt-4 border-gray-200">Risultati Calcolati</h3>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
      
      <!-- Pausa Pranzo Card -->
      <div id="pausaPranzoCard" class="p-4 rounded-lg shadow-xl bg-white border transition duration-150 ease-in-out">
        <div class="text-xs font-medium text-gray-500 mb-1">Durata Pausa Pranzo</div>
        <div id="pausaPranzo" class="text-3xl font-extrabold text-gray-900">00:00</div>
        <div id="pausaPranzoStatus" class="text-xs font-semibold mt-1 text-gray-600">Inserisci orari</div>
      </div>
      
      <!-- Uscita Teorica Card -->
      <div class="p-4 rounded-lg shadow-xl bg-purple-100 border border-purple-300">
        <div class="text-xs font-medium text-purple-700 mb-1">Uscita per 8 Ore (Teorica)</div>
        <div id="uscitaTeorica" class="text-3xl font-extrabold text-purple-800">00:00</div>
        <div class="text-xs font-semibold text-purple-700 mt-1" title="Uscita richiesta per totalizzare 8 ore (con pausa minima di 1:00h)">1:00h di pausa inclusa</div>
      </div>
      
      <!-- Totale Ore Lavorate Card -->
      <div class="p-4 rounded-lg shadow-xl bg-green-100 border border-green-300">
        <div class="text-xs font-medium text-green-700 mb-1">Totale Ore Lavorate</div>
        <div id="totalHours" class="text-3xl font-extrabold text-green-800">00:00</div>
        <div class="text-xs font-semibold text-green-700 mt-1">(Mattina + Pomeriggio)</div>
      </div>
    </div>

    <div class="flex justify-center mt-8 space-x-4">
      <button id="saveButton" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-xl hover:bg-green-700 transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-green-500/50">
        Salva Orario per questa Data
      </button>

      <!-- Aggiunta pulsanti per esportazione -->
      <label for="exportStartDate" class="font-semibold self-center">Da:</label>
      <input type="date" id="exportStartDate" class="px-3 py-2 border border-gray-300 rounded-md" />
      <label for="exportEndDate" class="font-semibold self-center">A:</label>
      <input type="date" id="exportEndDate" class="px-3 py-2 border border-gray-300 rounded-md" />
      <button id="exportDataBtn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-xl hover:bg-blue-700 transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-blue-500/50">
        Esporta Dati
      </button>
    </div>
  </div>
</div>

<script>
  // =======================================================================
  // CONFIGURAZIONE STATO LOCALE (LOCAL STORAGE)
  // =======================================================================

  // Stato e Variabili
  let currentCalendarDate = new Date();
  let selectedDate = new Date();
  let dailyStatuses = {};
  const LOCAL_STORAGE_PREFIX = "schedule-"; // Prefisso per le chiavi Local Storage

  // Costanti per i calcoli
  const TARGET_MINUTES = 480; // 8 ore (8 * 60)
  const MIN_BREAK = 60; // Pausa minima 1:00h

  // =======================================================================
  // UTILITY PER DATE E TEMPO
  // =======================================================================

  function formatDateId(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  /**
   * Converte una stringa oraria (es. HHMM o HH:MM) in minuti totali.
   * Rimuove i caratteri non numerici per robustezza.
   */
  function timeToMinutes(timeString) {
    if (!timeString) return 0;
    // Rimuove i caratteri non numerici e fa il pad a 4 cifre per la conversione
    const digitsOnly = timeString.replace(/[^0-9]/g, '').padStart(4, '0').substring(0, 4);

    if (digitsOnly === "0000") return 0; // 0000 = 0 minuti

    const hours = parseInt(digitsOnly.substring(0, 2), 10);
    const minutes = parseInt(digitsOnly.substring(2, 4), 10);
    
    // Convalida: se ore/minuti sono fuori range (es. 25:00), ritorna 0 minuti.
    if (hours > 23 || minutes > 59) return 0; 
    
    return hours * 60 + minutes;
  }
  
  /**
   * Converte minuti totali in una stringa oraria a 4 cifre (HHMM).
   * Viene utilizzato per i risultati intermedi e per il salvataggio.
   */
  function minutesToHoursString(totalMinutes) {
    if (totalMinutes < 0 || isNaN(totalMinutes)) return "0000";
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    
    const formattedHours = String(hours).padStart(2, "0");
    const formattedMinutes = String(minutes).padStart(2, "0");

    return formattedHours + formattedMinutes; // Ritorna HHMM
  }
  
  /**
   * Converte una stringa oraria a 4 cifre (HHMM) nel formato display (HH:MM).
   */
  function timeToDisplay(timeString) {
    // Gestisce sia input HHMM che input parziale/vuoto
    if (!timeString || timeString.length !== 4) return '00:00'; 
    
    const hours = timeString.substring(0, 2);
    const minutes = timeString.substring(2, 4);
    
    return `${hours}:${minutes}`;
  }
  
  /**
   * Pulisce l'input grezzo (es. '900' o '9:30') e lo formatta nel formato canonico a 4 cifre (HHMM).
   * Ritorna sempre HHMM.
   */
  function formatTimeInput(rawInput) {
    // 1. Rimuove i caratteri non numerici (es. '9:30' -> '930')
    let cleaned = rawInput.replace(/[^0-9]/g, '');

    if (cleaned.length === 0) return '0000';
    
    // 2. Logica di pad per l'input:
    // Esempi: "8" -> "0800", "17" -> "1700", "1735" -> "1735"
    if (cleaned.length < 4) {
        if (cleaned.length <= 2) {
            // Se 1 o 2 cifre, assume ore complete
            cleaned = cleaned.padStart(2, '0') + '00';
        } else {
            // Se 3 cifre (es. '930'), tenta di inferire HHMM
            cleaned = cleaned.padStart(4, '0').substring(0, 4);
        }
    } else if (cleaned.length > 4) {
        cleaned = cleaned.substring(0, 4);
    }
    
    let hours = parseInt(cleaned.substring(0, 2), 10);
    let minutes = parseInt(cleaned.substring(2, 4), 10);

    // 3. Convalida (Clamping) e ricostruzione HHMM
    hours = Math.min(hours, 23);
    minutes = Math.min(minutes, 59);

    return String(hours).padStart(2, '0') + String(minutes).padStart(2, '0');
  }

  // =======================================================================
  // LOGICA CALCOLI
  // =======================================================================

  function updateDailyCalculations() {
    const tstartm = document.getElementById("entrataMattina").value.trim();
    const tendm = document.getElementById("uscitaPranzo").value.trim();
    const tstartp = document.getElementById("entrataPomeriggio").value.trim();
    const tendp = document.getElementById("uscitaSera").value.trim();
    
    // Conversione in minuti
    const mstartm = timeToMinutes(tstartm);
    const mendm = timeToMinutes(tendm);
    const mstartp = timeToMinutes(tstartp);
    const mendp = timeToMinutes(tendp);

    const morningDuration = Math.max(0, mendm - mstartm);
    const afternoonDuration = Math.max(0, mendp - mstartp);
    let breakDuration = 0; 
    
    if (mstartp > 0 && mendm > 0 && mstartp > mendm) {
        breakDuration = mstartp - mendm;
    } 

    const totalDuration = morningDuration + afternoonDuration;
    
    const totalHoursHHMM = minutesToHoursString(totalDuration);
    document.getElementById("totalHours").textContent = timeToDisplay(totalHoursHHMM);
    
    const pausaPranzoDisplay = document.getElementById("pausaPranzo");
    const pausaPranzoCard = document.getElementById("pausaPranzoCard");
    const pausaPranzoStatus = document.getElementById("pausaPranzoStatus");

    const breakDurationHHMM = minutesToHoursString(breakDuration);
    pausaPranzoDisplay.textContent = timeToDisplay(breakDurationHHMM); 

    pausaPranzoCard.classList.remove('bg-red-50', 'bg-blue-50', 'border-red-300', 'border-blue-300', 'border-gray-200');
    pausaPranzoDisplay.classList.remove('text-red-700', 'text-blue-700');
    pausaPranzoStatus.classList.remove('text-red-600', 'text-blue-600');
    pausaPranzoDisplay.classList.add('text-gray-900');
    pausaPranzoStatus.classList.add('text-gray-600');

    if (breakDuration > 0 && breakDuration < MIN_BREAK) {
        pausaPranzoCard.classList.add('bg-red-50', 'border-red-300');
        pausaPranzoDisplay.classList.add('text-red-700');
        pausaPranzoDisplay.classList.remove('text-gray-900');
        pausaPranzoStatus.textContent = `ATTENZIONE: Inferiore a ${MIN_BREAK/60}:00h.`;
        pausaPranzoStatus.classList.add('text-red-600');
        pausaPranzoStatus.classList.remove('text-gray-600');
    } else if (breakDuration >= MIN_BREAK) {
        pausaPranzoCard.classList.add('bg-blue-50', 'border-blue-300');
        pausaPranzoDisplay.classList.add('text-blue-700');
        pausaPranzoDisplay.classList.remove('text-gray-900');
        pausaPranzoStatus.textContent = `Pausa valida (${MIN_BREAK/60}:00h richiesto).`;
        pausaPranzoStatus.classList.add('text-blue-600');
        pausaPranzoStatus.classList.remove('text-gray-600');
    } else {
        pausaPranzoCard.classList.add('bg-white', 'border-gray-200');
        pausaPranzoStatus.textContent = `Nessun intervallo registrato.`;
    }

    const minutesNeededAfternoon = TARGET_MINUTES - morningDuration;
    let theoreticalExitDisplay = '00:00'; 
    
    if (morningDuration > 0) {
        if (minutesNeededAfternoon <= 0) {
            theoreticalExitDisplay = 'Raggiunte';
        } else {
            const m_min_start_p = mendm + MIN_BREAK; 
            let m_theoretical_start_p = m_min_start_p;

            if (mstartp > 0) {
                m_theoretical_start_p = Math.max(mstartp, m_min_start_p);
            } else {
                m_theoretical_start_p = m_min_start_p;
            }
            
            const theoreticalExitMinutes = m_theoretical_start_p + minutesNeededAfternoon;
            
            if (theoreticalExitMinutes < (24 * 60)) {
                const theoreticalExitHHMM = minutesToHoursString(theoreticalExitMinutes);
                theoreticalExitDisplay = timeToDisplay(theoreticalExitHHMM); 
            } else {
                theoreticalExitDisplay = 'Oltre 24h';
            }
        }
    } else {
         theoreticalExitDisplay = '----'; 
    }

    document.getElementById("uscitaTeorica").textContent = theoreticalExitDisplay;
  }

  // =======================================================================
  // PERSISTENZA (LOCAL STORAGE) E UI
  // =======================================================================

  const dayNames = ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"];
  const monthNames = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
  
  function renderCalendar() {
    const calendarHeader = document.getElementById("calendar-header");
    const calendarGrid = document.getElementById("calendar-grid");

    calendarHeader.innerHTML = `
      <button id="prevMonth" class="p-2 rounded-full hover:bg-white/20 transition duration-150"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
      <span class="text-xl font-semibold">${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}</span>
      <button id="nextMonth" class="p-2 rounded-full hover:bg-white/20 transition duration-150"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
    `;
    document.getElementById("prevMonth").onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); loadMonthStatuses(); };
    document.getElementById("nextMonth").onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); loadMonthStatuses(); };

    calendarGrid.innerHTML = "";
    dayNames.forEach(day => {
      const cell = document.createElement("div");
      cell.className = "text-center text-xs font-semibold text-gray-400 py-2";
      cell.textContent = day;
      calendarGrid.appendChild(cell);
    });

    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    const firstDayOfMonth = new Date(year, month, 1);
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const startDayIndex = (firstDayOfMonth.getDay() + 6) % 7; 

    for(let i = 0; i < startDayIndex; i++) {
      const emptyCell = document.createElement("div");
      emptyCell.className = "calendar-day";
      calendarGrid.appendChild(emptyCell);
    }

    for(let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      const dateId = formatDateId(date);
      const dayCell = document.createElement("div");
      dayCell.className = "calendar-day rounded-md m-1";
      dayCell.textContent = day;
      dayCell.dataset.date = dateId;

      if (dailyStatuses[dateId] === 'complete') dayCell.classList.add("status-complete");
      else if (dailyStatuses[dateId] === 'partial') dayCell.classList.add("status-partial");
      
      if (dateId === formatDateId(selectedDate)) dayCell.classList.add("selected");
      dayCell.onclick = () => { selectDate(date); };
      calendarGrid.appendChild(dayCell);
    }
  }

  function updateStatus(message, type = "info") {
    const statusElement = document.getElementById("status-message");
    if (!statusElement) return;
    statusElement.textContent = message;
    statusElement.className = "text-center text-sm mt-4 p-2 rounded-lg";
    if (type === "success") statusElement.classList.add("bg-green-100", "text-green-800");
    else if (type === "error") statusElement.classList.add("bg-red-100", "text-red-800");
    else statusElement.classList.add("bg-blue-100", "text-blue-800");
  }

  function selectDate(date) {
    const oldSelected = document.querySelector('.calendar-day.selected');
    if (oldSelected) oldSelected.classList.remove('selected');

    selectedDate = date;
    const dateId = formatDateId(selectedDate);
    const newSelected = document.querySelector(`.calendar-day[data-date="${dateId}"]`);
    if (newSelected) newSelected.classList.add('selected');

    document.getElementById("selected-date-display").textContent =
      dayNames[selectedDate.getDay()] + " " +
      selectedDate.getDate() + " " +
      monthNames[selectedDate.getMonth()] + " " +
      selectedDate.getFullYear();
    loadFormFromLocalStorage(); 
  }

  function loadMonthStatuses() {
    dailyStatuses = {};
    const currentYear = currentCalendarDate.getFullYear();
    const currentMonth = String(currentCalendarDate.getMonth() + 1).padStart(2, "0");
    const currentMonthPrefix = LOCAL_STORAGE_PREFIX + currentYear + "-" + currentMonth;

    try {
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith(currentMonthPrefix)) {
          const dateId = key.substring(LOCAL_STORAGE_PREFIX.length);
          const dataString = localStorage.getItem(key);
          let data = {};
          try { data = JSON.parse(dataString); } catch (e) { console.error("Errore parsing JSON per", key, e); continue; }

          let filled = 0;
          ["entrataMattina", "uscitaPranzo", "entrataPomeriggio", "uscitaSera"].forEach(f => {
            if (data[f] && data[f] !== "0000") filled++;
          });
          dailyStatuses[dateId] = filled === 4 ? 'complete' : (filled > 0 ? 'partial' : 'empty');
        }
      }
    } catch (e) {
      console.error("Errore nel caricamento stati mese:", e);
    }
    renderCalendar();
  }
  
  function collectDailyData() {
    const data = {};
    ["entrataMattina", "uscitaPranzo", "entrataPomeriggio", "uscitaSera"].forEach(field => {
      const input = document.getElementById(field).value.trim();
      data[field] = formatTimeInput(input);
    });
    return data;
  }
  
  function loadFormFromLocalStorage() {
    const dateId = formatDateId(selectedDate);
    const key = LOCAL_STORAGE_PREFIX + dateId;
    const dataString = localStorage.getItem(key);
    let dailyData = {};
    if (dataString) {
      try {
        dailyData = JSON.parse(dataString);
      } catch (e) { console.error("Errore parsing dati localStorage", e); dailyData = {}; }
    }
    ["entrataMattina", "uscitaPranzo", "entrataPomeriggio", "uscitaSera"].forEach(field => {
      const input = document.getElementById(field);
      const storedHHMM = dailyData[field] || "0000";
      input.value = timeToDisplay(storedHHMM);
      if (storedHHMM === "0000") input.classList.add('italic-placeholder'); else input.classList.remove('italic-placeholder');
    });
    updateDailyCalculations();
    updateStatus("Dati caricati dal Local Storage per la data selezionata.", "info");
  }

  function addInputListeners() {
    document.querySelectorAll(".time-input").forEach(input => {
      const initialValue = input.value;
      if (initialValue === '0000') {
        input.classList.add('italic-placeholder');
        input.value = '00:00';
      } else {
        input.value = timeToDisplay(formatTimeInput(initialValue));
      }
      input.addEventListener("input", updateDailyCalculations);
      input.addEventListener('focus', () => {
        let currentValue = input.value.replace(/:/g, '');
        if (currentValue === '0000' || currentValue === '000') currentValue = '';
        input.value = currentValue;
        input.classList.remove('italic-placeholder');
      });
      input.addEventListener("blur", () => {
        const rawValue = input.value;
        const standardizedHHMM = formatTimeInput(rawValue);
        let displayValue = timeToDisplay(standardizedHHMM);
        if (standardizedHHMM === '0000') {
          displayValue = '00:00';
          input.classList.add('italic-placeholder');
        } else {
          input.classList.remove('italic-placeholder');
        }
        input.value = displayValue;
        updateDailyCalculations();
      });
    });
    document.getElementById("saveButton").onclick = saveDataToLocalStorage;
  }

  function saveDataToLocalStorage() {
    const dateId = formatDateId(selectedDate);
    const key = LOCAL_STORAGE_PREFIX + dateId;
    const dataToSave = collectDailyData();

    updateStatus("Salvataggio in corso...", "info");
    try {
      localStorage.setItem(key, JSON.stringify(dataToSave));
      updateStatus("Orario per la data selezionata salvato con successo nel Local Storage!", "success");
      loadMonthStatuses();
    } catch (e) {
      console.error("Errore nel salvataggio su Local Storage:", e);
      updateStatus("Errore nel salvataggio. Controlla la console.", "error");
    }
  }

  // Funzione per esportare dati orari da localStorage in CSV
  function exportScheduleData() {
    const startDateInput = document.getElementById('exportStartDate').value;
    const endDateInput = document.getElementById('exportEndDate').value;

    if (!startDateInput || !endDateInput || startDateInput > endDateInput) {
      alert('Inserisci un intervallo di date valido.');
      return;
    }

    const startDate = new Date(startDateInput);
    const endDate = new Date(endDateInput);

    let exportText = 'Data,Entrata Mattina,Uscita Pranzo,Entrata Pomeriggio,Uscita Sera\n';

    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      const dateKey = LOCAL_STORAGE_PREFIX + formatDateId(d);
      const dataString = localStorage.getItem(dateKey);
      if (dataString) {
        try {
          const data = JSON.parse(dataString);
          exportText += `${formatDateId(d)},${data.entrataMattina || ''},${data.uscitaPranzo || ''},${data.entrataPomeriggio || ''},${data.uscitaSera || ''}\n`;
        } catch (error) {
          console.error('Errore nel parsing dati per la data ' + formatDateId(d), error);
        }
      }
    }

    const blob = new Blob([exportText], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `orari_${startDateInput}_to_${endDateInput}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  window.onload = function () {
    updateStatus("Applicazione inizializzata. Dati salvati in Local Storage.");
    renderCalendar();
    selectDate(new Date());
    addInputListeners();
    loadMonthStatuses();
    document.getElementById('exportDataBtn').addEventListener('click', exportScheduleData);
  };
</script>

</body>
</html>
