<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Timbrature</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

 <!-- ======================================================= -->
  <!-- CONFIGURAZIONE ICONE APP PER SCHERMATA HOME (RICHIESTA) -->
  <!-- ======================================================= -->
  
  <!-- 1. Favicon Standard (Utilizza il file ICO caricato) -->
  <link rel="icon" type="image/x-icon" href="uploaded:ico.ico">

  <!-- 2. Icone Apple Touch (iOS/iPad) -->
  <!-- NOTA: Questi percorsi DEVONO essere file PNG con le risoluzioni specificate. -->
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icons/apple-touch-icon-76x76.png">

  <!-- 3. Manifest PWA (Android/Web App) -->
  <link rel="manifest" href="./manifest.json">

  <!-- Colore del tema per l'interfaccia utente del browser su Android -->
  <meta name="theme-color" content="#3b82f6"> 
  
  <!-- ======================================================= -->
  
  <style>
    body { font-family: Inter, sans-serif; background-color: #f0f4f8; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 2rem 1rem; }
    #calendar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; }
    .calendar-day { transition: all 0.15s ease-in-out; cursor: pointer; user-select: none; height: 65px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #374151; font-weight: 500; padding: 4px; background-color: #f8fafc; border: 1px solid #e2e8f0; }
    .calendar-day.selected { border: none !important; } 
    .calendar-day:hover { background-color: #e0f2fe; transform: scale(1.02); }
    .day-number { font-size: 0.85rem; font-weight: 600; } 
    .day-name { font-size: 0.65rem; color: #6b7280; margin-bottom: 1px; } 
    .total-hours { font-size: 0.75rem; font-weight: 700; color: #059669; margin-top: 2px; }
    .calendar-day.selected { background-color: #3b82f6; color: white; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .calendar-day.selected .total-hours, .calendar-day.selected .day-name { color: #dbeafe; }
    .calendar-day.status-partial { background-color: #fffbeb; border-color: #fef08a; } 
    .calendar-day.status-partial .total-hours { color: #f59e0b; } 
    .calendar-day.status-complete { background-color: #f0fdf4; border-color: #bbf7d0; }
    .calendar-day.status-complete .total-hours { color: #10b981; } 
    .input-cell-wrapper { padding: 0; text-align: center; }
    .time-input { width: 100%; padding: 0.5rem 0.25rem; text-align: center; border: none; background-color: transparent; font-size: 1rem; line-height: 1.25rem; border-radius: 0.375rem; outline: none; transition: background-color 0.2s, box-shadow 0.2s; }
    .time-input:focus { background-color: #e0f2fe; box-shadow: 0 0 0 2px #93c5fd; }
    .time-input.italic-placeholder { color: #9ca3af; font-style: italic; } 
    .hidden { display: none; }
  </style>
</head>
<body>
<div class="w-full max-w-4xl p-4 sm:p-6 bg-white shadow-2xl rounded-xl border border-blue-100">

  <!-- SEZIONE LOGIN -->
  <div id="login-container">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Benvenuto in Timbrature</h1>
    <p class="text-center text-gray-600 mb-8">Inserisci un ID personale per salvare e sincronizzare i tuoi orari su pi√π dispositivi.</p>
    <div class="flex flex-col items-center gap-4">
      <input type="text" id="userIdInput" placeholder="Es: MarioRossi78" class="p-3 border border-gray-300 rounded-lg w-full max-w-sm text-center">
      <button id="loginButton" class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-xl hover:bg-blue-700">Accedi o Crea</button>
    </div>
  </div>

  <!-- SEZIONE APP (nascosta di default) -->
  <div id="app-container" class="hidden">
    <div class="flex justify-between items-center mb-6 border-b-2 pb-3 border-blue-200">
        <h1 class="text-3xl font-extrabold text-gray-800">Timbrature</h1>
        <div class="text-right">
            <p class="text-sm text-gray-500">ID Utente:</p>
            <p id="user-display" class="text-md text-gray-800 font-bold"></p>
            <button id="logout-button" class="text-sm text-blue-600 hover:underline mt-1">Cambia Utente</button>
        </div>
    </div>
    <div id="status-message" class="text-center text-sm mb-4 p-2 rounded-lg bg-blue-50 text-blue-800">Inizializzazione del sistema...</div>
  
    <div class="mb-8 p-4 bg-blue-600 rounded-xl shadow-lg">
      <div id="calendar-header" class="flex justify-between items-center mb-4 text-white">
          <button id="prevWeek" class="p-2 rounded-full hover:bg-white/20 transition duration-150"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
          <span class="text-xl font-semibold" id="week-display">Settimana Selezionata</span>
          <button id="nextWeek" class="p-2 rounded-full hover:bg-white/20 transition duration-150"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
      </div>
      <div id="calendar-grid" class="grid grid-cols-5 gap-1 text-center"></div>
    </div>
    
    <div id="daily-schedule-form" class="p-6 border border-gray-200 rounded-xl bg-gray-50 shadow-inner">
      <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center"><span id="selected-date-display" class="text-blue-600">Seleziona un giorno</span></h2>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-300 border border-gray-200 rounded-lg">
          <thead class="bg-blue-100/50">
            <tr>
              <th class="px-3 py-3 text-left text-sm font-medium text-gray-700 w-1/2">Campo Orario</th>
              <th class="px-3 py-3 text-center text-sm font-medium text-gray-700 w-1/2">Valore (HH:MM)</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr>
              <td class="px-3 py-3 text-sm font-medium text-gray-900">Entrata Mattina</td>
              <td class="input-cell-wrapper border-l border-r border-gray-200">
                  <div class="flex items-center gap-1 p-1">
                      <input type="text" id="entrataMattina" class="time-input flex-grow" value="00:00">
                      <button type="button" data-target="entrataMattina" class="set-time-btn p-2 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>
                  </div>
              </td>
            </tr>
            <tr>
              <td class="px-3 py-3 text-sm font-medium text-gray-900">Uscita Pranzo</td>
              <td class="input-cell-wrapper border-l border-r border-gray-200">
                  <div class="flex items-center gap-1 p-1">
                      <input type="text" id="uscitaPranzo" class="time-input flex-grow" value="00:00">
                      <button type="button" data-target="uscitaPranzo" class="set-time-btn p-2 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>
                  </div>
              </td>
            </tr>
            <tr>
              <td class="px-3 py-3 text-sm font-medium text-gray-900">Entrata Pomeriggio</td>
              <td class="input-cell-wrapper border-l border-r border-gray-200">
                  <div class="flex items-center gap-1 p-1">
                      <input type="text" id="entrataPomeriggio" class="time-input flex-grow" value="00:00">
                      <button type="button" data-target="entrataPomeriggio" class="set-time-btn p-2 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>
                  </div>
              </td>
            </tr>
            <tr>
              <td class="px-3 py-3 text-sm font-medium text-gray-900">Uscita Sera</td>
              <td class="input-cell-wrapper border-l border-r border-gray-200">
                  <div class="flex items-center gap-1 p-1">
                      <input type="text" id="uscitaSera" class="time-input flex-grow" value="00:00">
                      <button type="button" data-target="uscitaSera" class="set-time-btn p-2 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>
                  </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="flex justify-center mt-6 mb-8"> 
        <button id="saveButton" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-xl hover:bg-green-700">Salva orario</button>
      </div>

      <h3 class="text-xl font-bold text-gray-700 mt-6 mb-3 text-center border-t pt-4 border-gray-200">Risultati Calcolati Giornalieri</h3>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
        <div class="p-4 rounded-lg shadow-xl bg-green-100 border border-green-300">
          <div class="text-xs font-medium text-green-700 mb-1">Totale Ore Lavorate</div>
          <div id="totalHours" class="text-3xl font-extrabold text-green-800">00:00</div>
          <div class="text-xs font-semibold text-green-700 mt-1">(Mattina + Pomeriggio)</div>
        </div>
        <div class="p-4 rounded-lg shadow-xl bg-purple-100 border border-purple-300">
          <div class="text-xs font-medium text-purple-700 mb-1">Uscita per 8 Ore (Teorica)</div>
          <div id="uscitaTeorica" class="text-3xl font-extrabold text-purple-800">---</div>
          <div class="text-xs font-semibold text-purple-700 mt-1">8:00h di lavoro richiesto</div>
        </div>
        <div id="pausaPranzoCard" class="p-4 rounded-lg shadow-xl bg-white border">
          <div class="text-xs font-medium text-gray-500 mb-1">Durata Pausa Pranzo</div>
          <div id="pausaPranzo" class="text-3xl font-extrabold text-gray-900">00:00</div>
          <div id="pausaPranzoStatus" class="text-xs font-semibold mt-1 text-gray-600">Inserisci orari</div>
        </div>
      </div>
    </div>
    
    <div class="mt-8 p-6 border border-gray-200 rounded-xl bg-indigo-50 shadow-inner">
      <h3 class="text-xl font-bold text-gray-700 mb-4 text-center">Esporta Storico Orari</h3>
      <div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
        <div>
          <label for="startDate" class="block text-sm font-medium text-gray-700">Data Inizio:</label>
          <input type="date" id="startDate" class="mt-1 p-2 w-full border border-gray-300 rounded-md">
        </div>
        <div>
          <label for="endDate" class="block text-sm font-medium text-gray-700">Data Fine:</label>
          <input type="date" id="endDate" class="mt-1 p-2 w-full border border-gray-300 rounded-md">
        </div>
        <button id="exportButton" class="w-full sm:w-auto mt-6 sm:mt-4 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-xl hover:bg-indigo-700">
          Esporta in Excel (.xlsx)
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ======================================================================= -->
<!-- SCRIPT FIREBASE E LOGICA APPLICAZIONE -->
<!-- ======================================================================= -->

<!-- Firebase App (Compat) -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<!-- Servizi Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

<script>


  // =======================================================================
  // REGISTRAZIONE PWA (Service Worker)
  // =======================================================================
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      // CORREZIONE: Uso del percorso relativo './' per risolvere l'errore del protocollo URL
      // NOTA: il percorso per service-worker.js √® ancora valido se si trova nella stessa directory
      navigator.serviceWorker.register('./service-worker.js')
        .then(registration => {
          console.log('Service Worker registrato con successo:', registration.scope);
          // Non aggiorniamo lo stato qui per non confondere l'utente
        })
        .catch(error => {
          console.error('Registrazione Service Worker fallita:', error);
          updateStatus("ATTENZIONE: Registrazione PWA fallita. L'icona potrebbe non essere corretta.", "error");
        });
    });
  }


  // La tua configurazione di Firebase.
  const firebaseConfig = {
    apiKey: "AIzaSyBLf5rM8ex0AxlkRM-bluadFgPejb4sLyo",
    authDomain: "orari-95dbc.firebaseapp.com",
    projectId: "orari-95dbc",
    storageBucket: "orari-95dbc.firebasestorage.app",
    messagingSenderId: "296312974735",
    appId: "1:296312974735:web:9d8631f5296ee5c93f6ffa",
    measurementId: "G-QB58E21SDQ"
  };

  // Inizializzazione di Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  let userId = null; // Questo sar√† l'ID personale inserito dall'utente

  // Variabili e costanti globali dell'applicazione
  let currentWeekStart = getStartOfWeek(new Date());
  let selectedDate = new Date();
  
  const TARGET_MINUTES = 480;
  const MIN_BREAK = 60;
  
  const dayNamesFull = ["Domenica", "Luned√¨", "Marted√¨", "Mercoled√¨", "Gioved√¨", "Venerd√¨", "Sabato"];
  const dayNamesShort = ["LUN", "MAR", "MER", "GIO", "VEN"];
  const monthNames = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];

  // Funzioni di utilit√†
  function getStartOfWeek(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day === 0) ? 6 : (day - 1);
    d.setDate(d.getDate() - diff);
    d.setHours(0, 0, 0, 0);
    return d;
  }

  function formatDateId(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }
    
  function timeToMinutes(timeString) {
    if (!timeString) return 0;
    const digitsOnly = timeString.replace(/[^0-9]/g, '').padStart(4, '0').substring(0, 4);
    if (digitsOnly === "0000") return 0;
    const hours = parseInt(digitsOnly.substring(0, 2), 10);
    const minutes = parseInt(digitsOnly.substring(2, 4), 10);
    if (hours > 23 || minutes > 59) return 0;
    return hours * 60 + minutes;
  }

  function minutesToHoursString(totalMinutes) {
    if (totalMinutes < 0 || isNaN(totalMinutes)) return "0000";
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return String(hours).padStart(2, '0') + String(minutes).padStart(2, '0');
  }

  function timeToDisplay(timeString) {
    if (!timeString || timeString.length !== 4) return '00:00';
    return `${timeString.substring(0, 2)}:${timeString.substring(2, 4)}`;
  }
  
  function formatTimeInput(rawInput) {
    let cleaned = rawInput.replace(/[^0-9]/g, '');
    if (cleaned.length === 0) return '0000';
    if (cleaned.length < 4) {
        cleaned = cleaned.length <= 2 ? cleaned.padStart(2, '0') + '00' : cleaned.padStart(4, '0');
    }
    let hours = Math.min(parseInt(cleaned.substring(0, 2), 10), 23);
    let minutes = Math.min(parseInt(cleaned.substring(2, 4), 10), 59);
    return String(hours).padStart(2, '0') + String(minutes).padStart(2, '0');
  }

  function getCurrentFormattedTime() {
    const now = new Date();
    return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  }

  // Funzioni principali dell'applicazione
  function calculateDurations(data) {
    const mE1 = timeToMinutes(data.entrataMattina);
    const mU1 = timeToMinutes(data.uscitaPranzo);
    const mE2 = timeToMinutes(data.entrataPomeriggio);
    const mU2 = timeToMinutes(data.uscitaSera);
    const morningWorkMinutes = (mE1 > 0 && mU1 > mE1) ? (mU1 - mE1) : 0;
    const afternoonWorkMinutes = (mE2 > 0 && mU2 > mE2) ? (mU2 - mE2) : 0;
    const totalDuration = morningWorkMinutes + afternoonWorkMinutes;
    const breakDuration = (mU1 > 0 && mE2 > mU1) ? (mE2 - mU1) : 0;
    let theoreticalExitDisplay = '---';
    if (mE1 > 0) {
        let theoreticalExitMinutes = 0;
        if (mU1 > mE1 && mE2 > mU1) {
            theoreticalExitMinutes = mE2 + Math.max(0, TARGET_MINUTES - morningWorkMinutes);
        } else {
            theoreticalExitMinutes = mE1 + TARGET_MINUTES + MIN_BREAK;
        }
        theoreticalExitDisplay = timeToDisplay(minutesToHoursString(theoreticalExitMinutes));
    }
    return {
        totalDurationMinutes: totalDuration,
        totalHoursDisplay: timeToDisplay(minutesToHoursString(totalDuration)),
        breakDurationDisplay: timeToDisplay(minutesToHoursString(breakDuration)),
        breakDurationMinutes: breakDuration,
        theoreticalExitDisplay: theoreticalExitDisplay
    };
  }

  function updateDailyCalculations() {
    const inputValues = collectDailyData();
    const results = calculateDurations(inputValues);
    document.getElementById("totalHours").textContent = results.totalHoursDisplay;
    const pausaPranzoCard = document.getElementById("pausaPranzoCard");
    const pausaPranzoStatus = document.getElementById("pausaPranzoStatus");
    document.getElementById("pausaPranzo").textContent = results.breakDurationDisplay;
    pausaPranzoCard.className = 'p-4 rounded-lg shadow-xl border';
    if (results.breakDurationMinutes > 0 && results.breakDurationMinutes < MIN_BREAK) {
        pausaPranzoCard.classList.add('bg-red-50', 'border-red-300');
        pausaPranzoStatus.textContent = `ATTENZIONE: Inferiore a ${MIN_BREAK/60}:00h.`;
    } else if (results.breakDurationMinutes >= MIN_BREAK) {
        pausaPranzoCard.classList.add('bg-blue-50', 'border-blue-300');
        pausaPranzoStatus.textContent = `Pausa valida.`;
    } else {
        pausaPranzoStatus.textContent = `Nessun intervallo.`;
    }
    document.getElementById("uscitaTeorica").textContent = results.theoreticalExitDisplay;
    if (selectedDate) {
        const dateId = formatDateId(selectedDate);
        const dayCell = document.querySelector(`.calendar-day[data-date="${dateId}"]`);
        if (dayCell) {
            updateDayCellStatus(dayCell, results.totalDurationMinutes, results.totalHoursDisplay, inputValues);
        }
    }
  }
  
  function updateDayCellStatus(dayCell, totalMinutes, totalHoursDisplay, data = {}) {
    dayCell.classList.remove("status-partial", "status-complete");
    const hoursSpan = dayCell.querySelector('.total-hours') || document.createElement('span');
    hoursSpan.className = 'total-hours';
    const filledCount = Object.values(data).filter(v => v && v !== "0000" && v.length === 4).length;
    if (filledCount > 0) {
        dayCell.classList.add(totalMinutes >= TARGET_MINUTES ? "status-complete" : "status-partial");
        hoursSpan.textContent = totalHoursDisplay;
        if (!dayCell.contains(hoursSpan)) dayCell.appendChild(hoursSpan);
    } else {
        if (dayCell.contains(hoursSpan)) dayCell.removeChild(hoursSpan);
    }
  }
  
  async function saveDataToFirestore() {
    if (!userId) {
        updateStatus("Nessun ID utente. Impossibile salvare.", "error");
        return;
    }
    const dateId = formatDateId(selectedDate);
    const dataToSave = collectDailyData();
    dataToSave.dateId = dateId; 

    updateStatus("Salvataggio su server...", "info");
    try {
      const docRef = db.collection("users").doc(userId).collection("timbrature").doc(dateId);
      await docRef.set(dataToSave);
      updateStatus("Orario salvato con successo!", "success");
      await renderCalendar();
    } catch (e) {
      console.error("Errore salvataggio:", e);
      updateStatus("Errore nel salvataggio.", "error");
    }
  }

  async function loadFormFromFirestore() {
    if (!userId) return;
    const dateId = formatDateId(selectedDate);
    const docRef = db.collection("users").doc(userId).collection("timbrature").doc(dateId);
    
    try {
        const docSnap = await docRef.get();
        let dailyData = docSnap.exists ? docSnap.data() : {};
        
        ["entrataMattina", "uscitaPranzo", "entrataPomeriggio", "uscitaSera"].forEach(field => {
          const input = document.getElementById(field);
          const storedHHMM = dailyData[field] || "0000";
          input.value = timeToDisplay(storedHHMM);
          if (storedHHMM === "0000") input.classList.add('italic-placeholder');
          else input.classList.remove('italic-placeholder');
        });

        updateDailyCalculations();
        updateStatus(`Dati per ${dateId} caricati.`, "info");
    } catch(error) {
        console.error("Errore caricamento:", error);
        updateStatus("Errore nel caricamento dei dati.", "error");
    }
  }

  async function renderCalendar() {
    if (!userId) return;

    const calendarGrid = document.getElementById("calendar-grid");
    calendarGrid.innerHTML = "";
    
    const weekDates = [];
    for(let i = 0; i < 5; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(currentWeekStart.getDate() + i);
        weekDates.push(date);
    }
    
    document.getElementById("week-display").textContent = 
        `${weekDates[0].getDate()} ${monthNames[weekDates[0].getMonth()].substring(0, 3)} - ${weekDates[4].getDate()} ${monthNames[weekDates[4].getMonth()].substring(0, 3)}`;

    const startRange = formatDateId(weekDates[0]);
    const endRange = formatDateId(weekDates[4]);
    const timbratureCollection = db.collection("users").doc(userId).collection("timbrature");
    const q = timbratureCollection.where("dateId", ">=", startRange).where("dateId", "<=", endRange);
    
    const weeklyData = {};
    try {
        const querySnapshot = await q.get();
        querySnapshot.forEach((doc) => { weeklyData[doc.id] = doc.data(); });
    } catch(error) {
        console.error("Errore recupero dati settimanali:", error);
        updateStatus("Errore di connessione al database.", "error");
    }
    
    weekDates.forEach((date, index) => {
      const dateId = formatDateId(date);
      const dayCell = document.createElement("div");
      dayCell.className = "calendar-day rounded-md m-1";
      dayCell.dataset.date = dateId;
      dayCell.innerHTML = `<span class="day-name">${dayNamesShort[index]}</span><span class="day-number">${date.getDate()}</span>`;

      const data = weeklyData[dateId];
      if (data) {
        const durations = calculateDurations(data);
        updateDayCellStatus(dayCell, durations.totalDurationMinutes, durations.totalHoursDisplay, data);
      }
      
      if (dateId === formatDateId(selectedDate)) dayCell.classList.add("selected");
      dayCell.onclick = () => selectDate(date);
      calendarGrid.appendChild(dayCell);
    });
  }

  async function exportDataAsXLSX() {
    if (!userId) return;

    const startDateInputVal = document.getElementById("startDate").value;
    const endDateInputVal = document.getElementById("endDate").value;
    if (!startDateInputVal || !endDateInputVal) {
        updateStatus("Seleziona un intervallo di date.", "error");
        return;
    }
    
    updateStatus("Recupero dati per l'esportazione...", "info");
    
    const timbratureCollection = db.collection("users").doc(userId).collection("timbrature");
    const q = timbratureCollection.where("dateId", ">=", startDateInputVal).where("dateId", "<=", endDateInputVal);

    try {
        const querySnapshot = await q.get();
        if (querySnapshot.empty) {
            updateStatus("Nessun dato trovato.", "error");
            return;
        }

        const exportData = [];
        querySnapshot.forEach(doc => {
            const data = doc.data();
            const durations = calculateDurations(data);
            exportData.push({
                "Data": data.dateId,
                "Entrata Mattina": timeToDisplay(data.entrataMattina || "0000"),
                "Uscita Pranzo": timeToDisplay(data.uscitaPranzo || "0000"),
                "Entrata Pomeriggio": timeToDisplay(data.entrataPomeriggio || "0000"),
                "Uscita Sera": timeToDisplay(data.uscitaSera || "0000"),
                "Pausa Pranzo": durations.breakDurationDisplay,
                "Totale Ore Lavorate": durations.totalHoursDisplay
            });
        });
        
        exportData.sort((a, b) => a.Data.localeCompare(b.Data));

        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "RapportoOrari");
        const filename = `orari_${startDateInputVal}_${endDateInputVal}.xlsx`;
        XLSX.writeFile(workbook, filename);
        updateStatus("Esportazione completata!", "success");

    } catch(error) {
        console.error("Errore esportazione:", error);
        updateStatus("Esportazione fallita.", "error");
    }
  }

  function selectDate(date) {
    const oldSelected = document.querySelector('.calendar-day.selected');
    if (oldSelected) oldSelected.classList.remove('selected');
    selectedDate = date;
    const dateId = formatDateId(selectedDate);
    const newSelected = document.querySelector(`.calendar-day[data-date="${dateId}"]`);
    if (newSelected) newSelected.classList.add('selected');
    document.getElementById("selected-date-display").textContent = 
      `${dayNamesFull[selectedDate.getDay()]} ${selectedDate.getDate()} ${monthNames[selectedDate.getMonth()]}`;
    loadFormFromFirestore(); 
  }

  function changeWeek(offset) {
    currentWeekStart.setDate(currentWeekStart.getDate() + offset * 7);
    selectedDate = new Date(currentWeekStart); 
    renderCalendar();
    loadFormFromFirestore(); 
  }
  
  function collectDailyData() {
    return {
        entrataMattina: formatTimeInput(document.getElementById("entrataMattina").value),
        uscitaPranzo: formatTimeInput(document.getElementById("uscitaPranzo").value),
        entrataPomeriggio: formatTimeInput(document.getElementById("entrataPomeriggio").value),
        uscitaSera: formatTimeInput(document.getElementById("uscitaSera").value)
    };
  }

  function updateStatus(message, type = "info") {
    const statusElement = document.getElementById("status-message");
    statusElement.textContent = message;
    statusElement.className = "text-center text-sm mb-4 p-2 rounded-lg";
    if (type === "success") statusElement.classList.add("bg-green-100", "text-green-800");
    else if (type === "error") statusElement.classList.add("bg-red-100", "text-red-800");
    else statusElement.classList.add("bg-blue-100", "text-blue-800");
  }

  function initializeAppLogic() {
    document.getElementById("prevWeek").onclick = () => changeWeek(-1);
    document.getElementById("nextWeek").onclick = () => changeWeek(1);

    document.querySelectorAll(".time-input").forEach(input => {
      input.addEventListener("input", updateDailyCalculations);
      input.addEventListener('focus', () => {
        if (input.value.replace(/:/g, '') === '0000') input.value = '';
        input.classList.remove('italic-placeholder');
      });
      input.addEventListener("blur", () => {
        const formatted = formatTimeInput(input.value);
        input.value = timeToDisplay(formatted);
        if (formatted === '0000') input.classList.add('italic-placeholder');
        updateDailyCalculations();
      });
    });

    document.querySelectorAll('.set-time-btn').forEach(button => {
        button.addEventListener('click', () => {
            const inputField = document.getElementById(button.dataset.target);
            if (inputField) {
                inputField.value = getCurrentFormattedTime();
                inputField.classList.remove('italic-placeholder');
                inputField.dispatchEvent(new Event('blur'));
            }
        });
    });

    document.getElementById("saveButton").onclick = saveDataToFirestore;

    const today = new Date();
    selectedDate = (today.getDay() === 0 || today.getDay() === 6) ? getStartOfWeek(today) : today;
    currentWeekStart = getStartOfWeek(selectedDate);
    
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    document.getElementById('startDate').value = formatDateId(firstDayOfMonth);
    document.getElementById('endDate').value = formatDateId(lastDayOfMonth);
    document.getElementById("exportButton").onclick = exportDataAsXLSX;
    
    renderCalendar();
    selectDate(selectedDate);
  }

  // GESTIONE DELL'AUTENTICAZIONE SEMPLIFICATA
  window.onload = function () {
    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const userDisplay = document.getElementById('user-display');
    const logoutButton = document.getElementById('logout-button');
    const loginButton = document.getElementById('loginButton');
    const userIdInput = document.getElementById('userIdInput');
    
    // Funzione per mostrare l'app
    function showApp(currentUserId) {
        userId = currentUserId;
        userDisplay.textContent = userId;
        loginContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        initializeAppLogic();
    }

    // Funzione per mostrare il login
    function showLogin() {
        loginContainer.classList.remove('hidden');
        appContainer.classList.add('hidden');
    }

    // Controlla se un utente √® gi√† salvato in locale
    const savedUserId = localStorage.getItem('timbratureUserId');
    if (savedUserId) {
        showApp(savedUserId);
    } else {
        showLogin();
    }

    // Gestione click sul pulsante di login
    loginButton.addEventListener('click', () => {
        const enteredId = userIdInput.value.trim();
        if (enteredId) {
            localStorage.setItem('timbratureUserId', enteredId);
            showApp(enteredId);
        } else {
            alert("Per favore, inserisci un ID utente.");
        }
    });

    // Gestione click sul pulsante di logout
    logoutButton.addEventListener('click', () => {
        localStorage.removeItem('timbratureUserId');
        userId = null;
        showLogin();
    });

    // Assicura la connessione a Firebase con utente anonimo
    auth.signInAnonymously().catch((error) => {
        console.error("Errore nell'autenticazione anonima:", error);
    });
  };
</script>
</body>
</html>