<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario Orario Giornaliero</title>
  <!-- TailwindCSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, sans-serif; background-color: #f0f4f8; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 2rem 1rem; }
    .input-cell-wrapper { padding: 0; text-align: center; }
    .time-input { width: 100%; padding: 0.5rem 0.25rem; text-align: center; border: none; background-color: transparent; font-size: 1rem; line-height: 1.25rem; border-radius: 0.375rem; outline: none; }
    .time-input:focus { background-color: #e0f2fe; box-shadow: 0 0 0 2px #93c5fd; }
    .time-input[value="0000"] { color: #9ca3af; font-style: italic; }
    .calendar-day { transition: all 0.15s ease-in-out; cursor: pointer; user-select: none; height: 48px; display: flex; align-items: center; justify-content: center; color: #374151; font-weight: 500; }
    .calendar-day:hover { background-color: #e0f2fe; transform: scale(1.05);}
    .calendar-day.selected { background-color: #3b82f6; color: white; font-weight: bold; border-radius: 0.375rem; }
    .calendar-day.status-partial { background-color: #fde68a; color: #92400e; font-weight: 600; }
    .calendar-day.status-complete { background-color: #a7f3d0; color: #065f46; font-weight: 600; }
  </style>

  <!-- Firebase (ES module), funziona su GitHub Pages e repo vanilla -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDocs, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Configurazione Firebase statica
    const firebaseConfig = {
      apiKey: "AIzaSyBLf5rM8ex0AxlkRM-bluadFgPejb4sLyo",
      authDomain: "orari-95dbc.firebaseapp.com",
      projectId: "orari-95dbc",
      storageBucket: "orari-95dbc.firebasestorage.app",
      messagingSenderId: "296312974735",
      appId: "1:296312974735:web:9d8631f5296ee5c93f6ffa",
      measurementId: "G-QB58E21SDQ"
    };

    // Stato programma
    let db, auth;
    let userId = null;
    let isAuthReady = false;
    let currentCalendarDate = new Date();
    let selectedDate = new Date();
    let dailyStatuses = {};
    let currentEditingCellId = null;
    let unsubscribeDailyData = null;

    // Utility 
    const dayNames = ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"];
    const monthNames = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
    function formatDateId(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }
    function minutesToHoursString(totalMinutes) {
      if (!totalMinutes || isNaN(totalMinutes)) return "0000";
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      return String(hours).padStart(2, "0") + String(minutes).padStart(2, "0");
    }
    function timeToMinutes(timeString) {
      if (!timeString || !/^\d{4}$/.test(timeString)) return 0;
      const hours = parseInt(timeString.substring(0,2));
      const minutes = parseInt(timeString.substring(2,4));
      return (hours*60 + minutes);
    }

    // Rendering Funzioni 
    function renderCalendar() {
      const calendarHeader = document.getElementById("calendar-header");
      const calendarGrid = document.getElementById("calendar-grid");
      calendarHeader.innerHTML = `
        <button id="prevMonth" class="p-2 rounded-full hover:bg-white/20">&lt;</button>
        <span class="text-xl font-semibold">${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}</span>
        <button id="nextMonth" class="p-2 rounded-full hover:bg-white/20">&gt;</button>
      `;
      document.getElementById("prevMonth").onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); loadMonthStatuses(); };
      document.getElementById("nextMonth").onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); loadMonthStatuses(); };

      calendarGrid.innerHTML = "";
      dayNames.forEach(day => {
        const cell = document.createElement("div");
        cell.className = "text-center text-xs font-semibold text-gray-400 py-2";
        cell.textContent = day;
        calendarGrid.appendChild(cell);
      });
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      const firstDayOfMonth = new Date(year, month, 1);
      const daysInMonth = new Date(year, month+1, 0).getDate();
      const startDayIndex = (firstDayOfMonth.getDay() + 6) % 7; // start monday

      for(let i=0; i<startDayIndex; i++) {
        const emptyCell = document.createElement("div");
        emptyCell.className = "calendar-day";
        calendarGrid.appendChild(emptyCell);
      }
      for(let day=1; day<=daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dateId = formatDateId(date);
        const dayCell = document.createElement("div");
        dayCell.className = "calendar-day rounded-md m-1";
        dayCell.textContent = day;
        dayCell.dataset.date = dateId;
        if (dailyStatuses[dateId] === 'complete') dayCell.classList.add("status-complete");
        else if (dailyStatuses[dateId] === 'partial') dayCell.classList.add("status-partial");
        if (dateId === formatDateId(selectedDate)) dayCell.classList.add("selected");
        dayCell.onclick = () => { selectDate(date); };
        calendarGrid.appendChild(dayCell);
      }
    }

    function updateStatus(message, type="info") {
      const statusElement = document.getElementById("status-message");
      if (!statusElement) return;
      statusElement.textContent = message;
      statusElement.className = "text-center text-sm mt-4 p-2 rounded-lg";
      if (type === "success") statusElement.classList.add("bg-green-100","text-green-800");
      else if (type === "error") statusElement.classList.add("bg-red-100","text-red-800");
      else statusElement.classList.add("bg-blue-100","text-blue-800");
    }

    // cambio data selezionata
    function selectDate(date) {
      selectedDate = date;
      renderCalendar();
      document.getElementById("selected-date-display").textContent =
        dayNames[selectedDate.getDay()] + " " +
        selectedDate.getDate() + " " +
        monthNames[selectedDate.getMonth()] + " " +
        selectedDate.getFullYear();
      startDailyDataListener();
    }

    // Firebase Funzioni
    async function loadMonthStatuses() {
      if (!isAuthReady || !userId) return;
      dailyStatuses = {};
      const colRef = collection(db, "artifacts", "default-app-id", "users", userId, "dailyschedule");
      try {
        const snapshot = await getDocs(colRef);
        const currentMonthId = currentCalendarDate.getFullYear() + "-" + String(currentCalendarDate.getMonth() + 1).padStart(2, "0");
        snapshot.forEach(docSnap => {
          const dateId = docSnap.id;
          if (dateId.startsWith(currentMonthId)) {
            const data = docSnap.data();
            let filled = 0;
            ["entrataMattina", "uscitaPranzo", "entrataPomeriggio", "uscitaSera"].forEach(f => {
              if (data[f] && data[f] !== "0000") filled++;
            });
            dailyStatuses[dateId] =
              filled === 4 ? 'complete' : (filled > 0 ? 'partial' : 'empty');
          }
        });
      } catch { /* Nessuna azione, errori a console */ }
      renderCalendar();
    }

    // <form e logica calcoli, listener...>
    function collectDailyData() {
      return {
        entrataMattina: document.getElementById("entrataMattina").value.trim(),
        uscitaPranzo: document.getElementById("uscitaPranzo").value.trim(),
        entrataPomeriggio: document.getElementById("entrataPomeriggio").value.trim(),
        uscitaSera: document.getElementById("uscitaSera").value.trim()
      };
    }

    function updateDailyCalculations() {
      const tstartm = document.getElementById("entrataMattina").value.trim();
      const tendm = document.getElementById("uscitaPranzo").value.trim();
      const tstartp = document.getElementById("entrataPomeriggio").value.trim();
      const tendp = document.getElementById("uscitaSera").value.trim();
      let morningDuration = Math.max(0, timeToMinutes(tendm) - timeToMinutes(tstartm));
      let afternoonDuration = Math.max(0, timeToMinutes(tendp) - timeToMinutes(tstartp));
      let breakDuration = Math.max(0, timeToMinutes(tstartp) - timeToMinutes(tendm));
      let totalDuration = morningDuration + afternoonDuration;
      document.getElementById("totalHours").textContent = minutesToHoursString(totalDuration);
      document.getElementById("pausaPranzo").textContent = minutesToHoursString(breakDuration);
      // Uscita teorica base: rientro + minuti restanti
      let mtheoreticalstartp = Math.max(timeToMinutes(tendm) + 60, timeToMinutes(tstartp));
      let minutesNeededAfternoon = 480 - morningDuration;
      let uscitaTeoricaVal = (mtheoreticalstartp > 0) ? mtheoreticalstartp + minutesNeededAfternoon : 0;
      document.getElementById("uscitaTeorica").textContent = minutesToHoursString(uscitaTeoricaVal);
    }

    function loadFormFromFirestore(dailyData = {}) {
      ["entrataMattina", "uscitaPranzo", "entrataPomeriggio", "uscitaSera"].forEach(field => {
        const input = document.getElementById(field);
        input.value = dailyData[field] || "0000";
      });
      updateDailyCalculations();
      updateStatus("Dati caricati per la data selezionata.", "success");
    }

    function addInputListeners() {
      document.querySelectorAll(".time-input").forEach(input => {
        input.addEventListener("input", updateDailyCalculations);
      });
      document.getElementById("saveButton").onclick = saveDataToFirestore;
    }

    // Listener Firestore giorno selezionato
    function startDailyDataListener() {
      if (!isAuthReady || !userId) return;
      if (unsubscribeDailyData) unsubscribeDailyData();
      const dateId = formatDateId(selectedDate);
      const docRef = doc(db, "artifacts", "default-app-id", "users", userId, "dailyschedule", dateId);
      unsubscribeDailyData = onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) loadFormFromFirestore(docSnap.data());
        else loadFormFromFirestore({});
      });
    }

    async function saveDataToFirestore() {
      if (!isAuthReady || !userId) return;
      const dateId = formatDateId(selectedDate);
      const docRef = doc(db, "artifacts", "default-app-id", "users", userId, "dailyschedule", dateId);
      updateStatus("Salvataggio in corso...", "info");
      try {
        await setDoc(docRef, collectDailyData());
        updateStatus("Orario per la data selezionata salvato con successo!", "success");
        loadMonthStatuses();
      } catch (e) {
        updateStatus("Errore nel salvataggio manuale.", "error");
      }
    }

    // Avvio
    window.onload = async function() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        await signInAnonymously(auth);
        onAuthStateChanged(auth, function(user) {
          if (user) {
            userId = user.uid;
            isAuthReady = true;
            updateStatus("Connesso al database. ID utente: " + userId.substring(0,8), "success");
            renderCalendar();
            selectDate(new Date());
            addInputListeners();
            loadMonthStatuses();
          }
        });
      } catch (e) {
        updateStatus("ERRORE CRITICO: " + (e.message || "Init error."), "error");
      }
    }
  </script>
</head>
<body>
  <div class="w-full max-w-4xl p-6 bg-white shadow-2xl rounded-xl border border-blue-100">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center border-b-2 pb-3 border-blue-200">Calendario Orario Giornaliero</h1>
    <div id="status-message" class="text-center text-sm mb-4 p-2 rounded-lg bg-blue-50 text-blue-800">Inizializzazione del sistema...</div>
    <div class="mb-8 p-4 bg-blue-600 text-white rounded-xl shadow-lg">
      <div id="calendar-header" class="flex justify-between items-center mb-4"></div>
      <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
    </div>
    <div id="daily-schedule-form" class="p-6 border border-gray-200 rounded-xl bg-gray-50 shadow-inner">
      <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center">Orario per <span id="selected-date-display" class="text-blue-600">Oggi</span></h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-300">
          <thead class="bg-blue-100/50">
            <tr>
              <th class="px-3 py-3 text-center text-sm font-medium text-gray-700">Campo</th>
              <th class="px-3 py-3 text-center text-sm font-medium text-gray-700">Valore</th>
              <th class="px-3 py-3 text-center text-sm font-medium text-gray-700 bg-blue-200/50">Risultato Calcolato</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr class="hover:bg-gray-50">
              <td class="px-3 py-3 text-sm font-medium text-gray-900">Entrata Mattina</td>
              <td class="input-cell-wrapper border-l border-r border-gray-200"><input type="text" id="entrataMattina" class="time-input" value="0000"></td>
              <td class="bg-transparent"></td>
            </tr>
            <tr class="hover:bg-gray-50">
              <td class="px-3 py-3 text-sm font-medium text-gray-900">Uscita Pranzo</td>
              <td class="input-cell-wrapper border-l border-r border-gray-200"><input type="text" id="uscitaPranzo" class="time-input" value="0000"></td>
              <td id="pausaPranzo" class="px-3 py-3 text-sm font-semibold text-gray-700 bg-blue-50 text-center" title="Durata Pausa">0000</td>
            </tr>
            <tr class="hover:bg-gray-50">
              <td class="px-3 py-3 text-sm font-medium text-gray-900">Entrata Pomeriggio</td>
              <td class="input-cell-wrapper border-l border-r border-gray-200"><input type="text" id="entrataPomeriggio" class="time-input" value="0000"></td>
              <td id="uscitaTeorica" class="px-3 py-3 text-sm font-bold text-purple-700 bg-purple-100 text-center" title="Uscita richiesta per totalizzare 8 ore con 100 min di pausa">0000</td>
            </tr>
            <tr class="hover:bg-gray-50">
              <td class="px-3 py-3 text-sm font-medium text-gray-900">Uscita Sera</td>
              <td class="input-cell-wrapper border-l border-r border-gray-200"><input type="text" id="uscitaSera" class="time-input" value="0000"></td>
              <td id="totalHours" class="px-3 py-3 text-sm font-extrabold text-green-700 bg-green-100 text-center" title="Totale ore lavorate (Mattina + Pomeriggio)">0000</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="flex justify-center mt-6">
        <button id="saveButton" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-xl hover:bg-green-700 transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-green-500/50">
          Salva Orario per questa Data
        </button>
      </div>
    </div>
  </div>
</body>
</html>
