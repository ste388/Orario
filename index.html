<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendario Settimanale L-V</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Libreria SheetJS per l'esportazione in Excel (.xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* Stili Base */
    body { font-family: Inter, sans-serif; background-color: #f0f4f8; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 2rem 1rem; }
    
    /* Layout della griglia settimanale L-V (5 colonne) */
    #calendar-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr); /* 5 colonne per L-V */
        gap: 2px;
    }

    /* Stili per le celle giorno L-V */
    .calendar-day { 
        transition: all 0.15s ease-in-out; 
        cursor: pointer; 
        user-select: none; 
        height: 80px; /* Altezza aumentata per il tocco mobile */
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        color: #374151; 
        font-weight: 500; 
        padding: 8px; 
        background-color: #f8fafc; /* Sfondo chiaro */
        border: 1px solid #e2e8f0;
    }
    
    /* Rimuove i bordi del giorno selezionato per non rovinare lo sfondo blu */
    .calendar-day.selected { border: none !important; } 

    .calendar-day:hover { background-color: #e0f2fe; transform: scale(1.02); }

    /* Stili interni alla cella giorno */
    .day-number { font-size: 0.95rem; font-weight: 600; }
    .day-name { font-size: 0.75rem; color: #6b7280; margin-bottom: 2px; }
    .total-hours { 
        font-size: 0.875rem; 
        font-weight: 700; 
        color: #059669; 
        margin-top: 3px; 
    }
    
    /* Selezionato (priorit√† massima) */
    .calendar-day.selected { background-color: #3b82f6; color: white; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .calendar-day.selected .total-hours { color: #bfdbfe; }
    .calendar-day.selected .day-name { color: #dbeafe; } /* Grigio chiaro per il nome del giorno */

    /* STATI */
    .calendar-day.status-partial { background-color: #fffbeb; border-color: #fef08a; } 
    .calendar-day.status-partial .total-hours { color: #f59e0b; } 
    
    .calendar-day.status-complete { background-color: #f0fdf4; border-color: #bbf7d0; }
    .calendar-day.status-complete .total-hours { color: #10b981; } 
    
    /* Input orario e bottone ora corrente */
    .input-cell-wrapper { padding: 0; text-align: center; }
    .time-input { width: 100%; padding: 0.5rem 0.25rem; text-align: center; border: none; background-color: transparent; font-size: 1rem; line-height: 1.25rem; border-radius: 0.375rem; outline: none; transition: background-color 0.2s, box-shadow 0.2s; }
    .time-input:focus { background-color: #e0f2fe; box-shadow: 0 0 0 2px #93c5fd; }
    .time-input.italic-placeholder { color: #9ca3af; font-style: italic; } 
    
  </style>
</head>
<body>
<div class="w-full max-w-4xl p-6 bg-white shadow-2xl rounded-xl border border-blue-100">
  <!-- MODIFICA APPLICATA QUI -->
  <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center border-b-2 pb-3 border-blue-200">Timbrature</h1>
  <div id="status-message" class="text-center text-sm mb-4 p-2 rounded-lg bg-blue-50 text-blue-800">Inizializzazione del sistema...</div>
  
  <!-- Sezione Calendario Settimanale -->
  <div class="mb-8 p-4 bg-blue-600 rounded-xl shadow-lg">
    <div id="calendar-header" class="flex justify-between items-center mb-4 text-white">
        <button id="prevWeek" class="p-2 rounded-full hover:bg-white/20 transition duration-150"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
        <span class="text-xl font-semibold" id="week-display">Settimana Selezionata</span>
        <button id="nextWeek" class="p-2 rounded-full hover:bg-white/20 transition duration-150"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
    </div>
    <div id="calendar-grid" class="grid grid-cols-5 gap-1 text-center">
        <!-- Celle dei giorni (L-V) caricate da JS -->
    </div>
  </div>
  
  <!-- Sezione Form Orari -->
  <div id="daily-schedule-form" class="p-6 border border-gray-200 rounded-xl bg-gray-50 shadow-inner">
    <!-- Visualizzazione data semplificata (SENZA ANNO) -->
    <h2 class="text-2xl font-bold text-gray-700 mb-4 text-center"><span id="selected-date-display" class="text-blue-600">Seleziona un giorno</span></h2>
    
    <!-- Tabella Input Orari -->
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-300 border border-gray-200 rounded-lg">
        <thead class="bg-blue-100/50">
          <tr>
            <th class="px-3 py-3 text-left text-sm font-medium text-gray-700 w-1/2">Campo Orario</th>
            <th class="px-3 py-3 text-center text-sm font-medium text-gray-700 w-1/2">Valore (HH:MM)</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- Entrata Mattina -->
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-3 text-sm font-medium text-gray-900">Entrata Mattina</td>
            <td class="input-cell-wrapper border-l border-r border-gray-200">
                <div class="flex items-center gap-1 p-1">
                    <input type="text" id="entrataMattina" class="time-input flex-grow" value="00:00">
                    <button type="button" data-target="entrataMattina" class="set-time-btn p-2 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-150 shadow-sm" title="Imposta ora corrente">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                </div>
            </td>
          </tr>
          <!-- Uscita Pranzo -->
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-3 text-sm font-medium text-gray-900">Uscita Pranzo</td>
            <td class="input-cell-wrapper border-l border-r border-gray-200">
                <div class="flex items-center gap-1 p-1">
                    <input type="text" id="uscitaPranzo" class="time-input flex-grow" value="00:00">
                    <button type="button" data-target="uscitaPranzo" class="set-time-btn p-2 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-150 shadow-sm" title="Imposta ora corrente">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                </div>
            </td>
          </tr>
          <!-- Entrata Pomeriggio -->
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-3 text-sm font-medium text-gray-900">Entrata Pomeriggio</td>
            <td class="input-cell-wrapper border-l border-r border-gray-200">
                <div class="flex items-center gap-1 p-1">
                    <input type="text" id="entrataPomeriggio" class="time-input flex-grow" value="00:00">
                    <button type="button" data-target="entrataPomeriggio" class="set-time-btn p-2 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-150 shadow-sm" title="Imposta ora corrente">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                </div>
            </td>
          </tr>
          <!-- Uscita Sera -->
          <tr class="hover:bg-gray-50">
            <td class="px-3 py-3 text-sm font-medium text-gray-900">Uscita Sera</td>
            <td class="input-cell-wrapper border-l border-r border-gray-200">
                <div class="flex items-center gap-1 p-1">
                    <input type="text" id="uscitaSera" class="time-input flex-grow" value="00:00">
                    <button type="button" data-target="uscitaSera" class="set-time-btn p-2 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-150 shadow-sm" title="Imposta ora corrente">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- Pulsante Salva -->
    <div class="flex justify-center mt-6 mb-8"> 
      <button id="saveButton" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-xl hover:bg-green-700 transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-green-500/50">
        Salva orario
      </button>
    </div>

    <!-- Sezione: Risultati Calcolati -->
    <h3 class="text-xl font-bold text-gray-700 mt-6 mb-3 text-center border-t pt-4 border-gray-200">Risultati Calcolati</h3>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
      
      <!-- Pausa Pranzo Card -->
      <div id="pausaPranzoCard" class="p-4 rounded-lg shadow-xl bg-white border transition duration-150 ease-in-out">
        <div class="text-xs font-medium text-gray-500 mb-1">Durata Pausa Pranzo</div>
        <div id="pausaPranzo" class="text-3xl font-extrabold text-gray-900">00:00</div>
        <div id="pausaPranzoStatus" class="text-xs font-semibold mt-1 text-gray-600">Inserisci orari</div>
      </div>
      
      <!-- Uscita Teorica Card (Aggiornata per mostrare sempre HH:MM) -->
      <div class="p-4 rounded-lg shadow-xl bg-purple-100 border border-purple-300">
        <div class="text-xs font-medium text-purple-700 mb-1">Uscita per 8 Ore (Teorica)</div>
        <div id="uscitaTeorica" class="text-3xl font-extrabold text-purple-800">---</div>
        <div class="text-xs font-semibold text-purple-700 mt-1" title="Uscita richiesta per totalizzare 8 ore di lavoro.">8:00h di lavoro richiesto</div>
      </div>
      
      <!-- Totale Ore Lavorate Card -->
      <div class="p-4 rounded-lg shadow-xl bg-green-100 border border-green-300">
        <div class="text-xs font-medium text-green-700 mb-1">Totale Ore Lavorate</div>
        <div id="totalHours" class="text-3xl font-extrabold text-green-800">00:00</div>
        <div class="text-xs font-semibold text-green-700 mt-1">(Mattina + Pomeriggio)</div>
      </div>
    </div>
  </div>
  
  <!-- Sezione: Esporta Dati -->
  <div class="mt-8 p-6 border border-gray-200 rounded-xl bg-indigo-50 shadow-inner">
    <h3 class="text-xl font-bold text-gray-700 mb-4 text-center">Esporta Storico Orari</h3>
    <div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
      <div class="w-full sm:w-auto">
        <label for="startDate" class="block text-sm font-medium text-gray-700">Data Inizio:</label>
        <input type="date" id="startDate" class="mt-1 p-2 w-full border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
      </div>
      <div class="w-full sm:w-auto">
        <label for="endDate" class="block text-sm font-medium text-gray-700">Data Fine:</label>
        <input type="date" id="endDate" class="mt-1 p-2 w-full border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
      </div>
      <button id="exportButton" class="w-full sm:w-auto mt-6 sm:mt-4 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-xl hover:bg-indigo-700 transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-indigo-500/50">
        Esporta in Excel (.xlsx)
      </button>
    </div>
  </div>
</div>

<script>
  // =======================================================================
  // CONFIGURAZIONE STATO LOCALE (LOCAL STORAGE)
  // =======================================================================

  // Stato e Variabili
  let currentWeekStart = getStartOfWeek(new Date()); // Inizia con il Luned√¨ della settimana corrente
  let selectedDate = new Date();
  let dailyStatuses = {}; 
  const LOCAL_STORAGE_PREFIX = "schedule-"; // Prefisso per le chiavi Local Storage

  // Costanti per i calcoli
  const TARGET_MINUTES = 480; // 8 ore (8 * 60)
  const MIN_BREAK = 60; // Pausa minima 1:00h
  
  // Nomi dei giorni e dei mesi
  const dayNamesFull = ["Domenica", "Luned√¨", "Marted√¨", "Mercoled√¨", "Gioved√¨", "Venerd√¨", "Sabato"];
  const dayNamesShort = ["LUN", "MAR", "MER", "GIO", "VEN"];
  const monthNames = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];


  // =======================================================================
  // UTILITY PER DATE E TEMPO
  // =======================================================================

  /**
   * Trova il Luned√¨ della settimana data (Luned√¨ = 1 in JS, ma 0 in nostra convenzione).
   * @param {Date} date - Data da cui partire.
   * @returns {Date} Il Luned√¨ della settimana.
   */
  function getStartOfWeek(date) {
    const d = new Date(date);
    const day = d.getDay(); // 0 = Domenica, 1 = Luned√¨, ..., 6 = Sabato
    // Calcola i giorni da sottrarre per arrivare al Luned√¨.
    // Luned√¨ (1) -> sottrai 0
    // Marted√¨ (2) -> sottrai 1
    // Domenica (0) -> sottrai 6
    const diff = (day === 0) ? 6 : (day - 1);
    
    d.setDate(d.getDate() - diff);
    d.setHours(0, 0, 0, 0);
    return d;
  }

  function formatDateId(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function timeToMinutes(timeString) {
    if (!timeString) return 0;
    const digitsOnly = timeString.replace(/[^0-9]/g, '').padStart(4, '0').substring(0, 4);

    if (digitsOnly === "0000") return 0;

    const hours = parseInt(digitsOnly.substring(0, 2), 10);
    const minutes = parseInt(digitsOnly.substring(2, 4), 10);
    
    if (hours > 23 || minutes > 59) return 0; 
    
    return hours * 60 + minutes;
  }
  
  function minutesToHoursString(totalMinutes) {
    if (totalMinutes < 0 || isNaN(totalMinutes)) return "0000";
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    
    const formattedHours = String(hours).padStart(2, "0");
    const formattedMinutes = String(minutes).padStart(2, "0");

    return formattedHours + formattedMinutes; // Ritorna HHMM
  }
  
  function timeToDisplay(timeString) {
    if (!timeString || timeString.length !== 4) return '00:00'; 
    
    const hours = timeString.substring(0, 2);
    const minutes = timeString.substring(2, 4);
    
    return `${hours}:${minutes}`;
  }
  
  function formatTimeInput(rawInput) {
    let cleaned = rawInput.replace(/[^0-9]/g, '');

    if (cleaned.length === 0) return '0000';
    
    if (cleaned.length < 4) {
        if (cleaned.length <= 2) {
            cleaned = cleaned.padStart(2, '0') + '00';
        } else {
            cleaned = cleaned.padStart(4, '0').substring(0, 4);
        }
    } else if (cleaned.length > 4) {
        cleaned = cleaned.substring(0, 4);
    }
    
    let hours = parseInt(cleaned.substring(0, 2), 10);
    let minutes = parseInt(cleaned.substring(2, 4), 10);

    hours = Math.min(hours, 23);
    minutes = Math.min(minutes, 59);

    return String(hours).padStart(2, '0') + String(minutes).padStart(2, '0');
  }

  function getCurrentFormattedTime() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
  }


  // =======================================================================
  // LOGICA CALCOLI (LA LOGICA DINAMICA RICHIESTA √à STATA MANTENUTA)
  // =======================================================================

  /**
   * Calcola le durate (lavoro totale, pausa, uscita teorica) dalla data (formato HHMM).
   */
  function calculateDurations(data) {
    const tE1 = (data.entrataMattina || "").trim();
    const tU1 = (data.uscitaPranzo || "").trim();  
    const tE2 = (data.entrataPomeriggio || "").trim();
    const tU2 = (data.uscitaSera || "").trim();  

    const mE1 = timeToMinutes(tE1); 
    const mU1 = timeToMinutes(tU1); 
    const mE2 = timeToMinutes(tE2); 
    const mU2 = timeToMinutes(tU2); 

    // 1. Durata Mattina
    const morningWorkMinutes = (mE1 > 0 && mU1 > mE1) ? (mU1 - mE1) : 0; 

    // 2. Durata Pomeriggio
    const afternoonWorkMinutes = (mE2 > 0 && mU2 > mE2) ? (mU2 - mE2) : 0; 
    
    // 3. Durata Totale Lavoro
    const totalDuration = morningWorkMinutes + afternoonWorkMinutes;

    // 4. Durata Pausa Pranzo
    let breakDuration = 0;
    if (mU1 > 0 && mE2 > mU1) { 
        breakDuration = mE2 - mU1; 
    } 

    // 5. Calcolo Uscita Teorica (Target 8 ore = 480 minuti)
    let theoreticalExitMinutes = 0;
    let theoreticalExitDisplay = '---'; 

    
    if (mE1 > 0 && mU1 > mE1 && mE2 > mU1) {
        // Logica Dinamica: (Se E1, U1 e E2 sono noti)
        const remainingWorkMinutes = Math.max(0, TARGET_MINUTES - morningWorkMinutes);
        theoreticalExitMinutes = mE2 + remainingWorkMinutes;
        theoreticalExitDisplay = timeToDisplay(minutesToHoursString(theoreticalExitMinutes));

    } else if (mE1 > 0) {
        // Logica Fallback: (Se ho solo E1)
        const TOTAL_TIME_SPAN_MINUTES = 480 + 60; // 9 hours
        theoreticalExitMinutes = mE1 + TOTAL_TIME_SPAN_MINUTES;
        theoreticalExitDisplay = timeToDisplay(minutesToHoursString(theoreticalExitMinutes));
    }
    
    return {
        totalDurationMinutes: totalDuration,
        totalHoursDisplay: timeToDisplay(minutesToHoursString(totalDuration)),
        breakDurationDisplay: timeToDisplay(minutesToHoursString(breakDuration)),
        breakDurationMinutes: breakDuration,
        theoreticalExitDisplay: theoreticalExitDisplay 
    };
  }

  function updateDailyCalculations() {
    // Raccoglie i valori direttamente dagli input per i calcoli in tempo reale
    const inputValues = {
        entrataMattina: document.getElementById("entrataMattina").value.trim(),
        uscitaPranzo: document.getElementById("uscitaPranzo").value.trim(),
        entrataPomeriggio: document.getElementById("entrataPomeriggio").value.trim(),
        uscitaSera: document.getElementById("uscitaSera").value.trim(),
    };

    const results = calculateDurations(inputValues);
    
    // 1. Totale Ore Lavorate
    document.getElementById("totalHours").textContent = results.totalHoursDisplay;
    
    // 2. Pausa Pranzo e Styling (Card)
    const pausaPranzoDisplay = document.getElementById("pausaPranzo");
    const pausaPranzoCard = document.getElementById("pausaPranzoCard");
    const pausaPranzoStatus = document.getElementById("pausaPranzoStatus"); 

    pausaPranzoDisplay.textContent = results.breakDurationDisplay; 

    pausaPranzoCard.className = 'p-4 rounded-lg shadow-xl border transition duration-150 ease-in-out';
    pausaPranzoDisplay.className = 'text-3xl font-extrabold';
    pausaPranzoStatus.className = 'text-xs font-semibold mt-1';
    
    if (results.breakDurationMinutes > 0 && results.breakDurationMinutes < MIN_BREAK) {
        pausaPranzoCard.classList.add('bg-red-50', 'border-red-300');
        pausaPranzoDisplay.classList.add('text-red-700');
        pausaPranzoStatus.textContent = `ATTENZIONE: Inferiore a ${MIN_BREAK/60}:00h.`;
        pausaPranzoStatus.classList.add('text-red-600');
    } else if (results.breakDurationMinutes >= MIN_BREAK) {
        pausaPranzoCard.classList.add('bg-blue-50', 'border-blue-300');
        pausaPranzoDisplay.classList.add('text-blue-700');
        pausaPranzoStatus.textContent = `Pausa valida (${MIN_BREAK/60}:00h richiesto).`;
        pausaPranzoStatus.classList.add('text-blue-600');
    } else {
        pausaPranzoCard.classList.add('bg-white', 'border-gray-200');
        pausaPranzoDisplay.classList.add('text-gray-900');
        pausaPranzoStatus.textContent = `Nessun intervallo registrato.`;
        pausaPranzoStatus.classList.add('text-gray-600');
    }

    // 3. Uscita Teorica (Ora sempre in HH:MM o '---')
    document.getElementById("uscitaTeorica").textContent = results.theoreticalExitDisplay;

    // 4. Aggiorna lo stato nel calendario, solo se una data √® selezionata
    if (selectedDate) {
        const dateId = formatDateId(selectedDate);
        const dayCell = document.querySelector(`.calendar-day[data-date="${dateId}"]`);
        if (dayCell) {
            updateDayCellStatus(dayCell, results.totalDurationMinutes, results.totalHoursDisplay);
        }
    }
  }
  
  // =======================================================================
  // PERSISTENZA (LOCAL STORAGE) E UI (Settimanale L-V)
  // =======================================================================
  
  /**
   * Aggiorna lo stato visivo di una cella giorno.
   */
  function updateDayCellStatus(dayCell, totalMinutes, totalHoursDisplay) {
        dayCell.classList.remove("status-partial", "status-complete");
        const hoursSpan = dayCell.querySelector('.total-hours') || document.createElement('span');
        hoursSpan.className = 'total-hours';
        
        if (totalMinutes > 0) {
            if (totalMinutes >= TARGET_MINUTES) {
                dayCell.classList.add("status-complete");
            } else {
                dayCell.classList.add("status-partial");
            }
            hoursSpan.textContent = totalHoursDisplay;
            if (!dayCell.contains(hoursSpan)) {
                dayCell.appendChild(hoursSpan);
            }
        } else {
             // Rimuove l'indicatore di ore se sono 0
            if (dayCell.contains(hoursSpan)) {
                dayCell.removeChild(hoursSpan);
            }
        }
  }


  function renderCalendar() {
    const calendarHeader = document.getElementById("week-display");
    const calendarGrid = document.getElementById("calendar-grid");

    calendarGrid.innerHTML = "";
    dailyStatuses = {}; // Ricarica lo stato per la nuova settimana

    const weekDates = [];
    for(let i = 0; i < 5; i++) { // L-V
        const date = new Date(currentWeekStart);
        date.setDate(currentWeekStart.getDate() + i);
        weekDates.push(date);
    }
    
    // Aggiorna l'header della settimana (SENZA ANNO)
    const endOfWeek = new Date(weekDates[4]);
    const weekRange = `${weekDates[0].getDate()} ${monthNames[weekDates[0].getMonth()].substring(0, 3)} - ${endOfWeek.getDate()} ${monthNames[endOfWeek.getMonth()].substring(0, 3)}`;
    calendarHeader.textContent = weekRange;


    weekDates.forEach((date, index) => {
      const dateId = formatDateId(date);
      const dayCell = document.createElement("div");
      dayCell.className = "calendar-day rounded-md m-1";
      dayCell.dataset.date = dateId;

      // Carica i dati dal localStorage per questo giorno
      const dataString = localStorage.getItem(LOCAL_STORAGE_PREFIX + dateId);
      let dataStatus = null;
      if (dataString) {
          try {
              const data = JSON.parse(dataString);
              const durations = calculateDurations(data); 
              let filled = 0;
              ["entrataMattina", "uscitaPranzo", "entrataPomeriggio", "uscitaSera"].forEach(f => {
                    if (data[f] && data[f] !== "0000") filled++;
              });

              dataStatus = {
                  status: filled === 4 ? 'complete' : (filled > 0 ? 'partial' : 'empty'),
                  totalHours: durations.totalHoursDisplay,
                  totalMinutes: durations.totalDurationMinutes
              };
              dailyStatuses[dateId] = dataStatus;
          } catch(e) { /* silent fail */ }
      }
      
      // Contenuto della cella
      dayCell.innerHTML = `
          <span class="day-name">${dayNamesShort[index]}</span>
          <span class="day-number">${date.getDate()}</span>
      `;

      if (dataStatus) {
         updateDayCellStatus(dayCell, dataStatus.totalMinutes, dataStatus.totalHours);
      }
      
      // Seleziona il giorno
      if (dateId === formatDateId(selectedDate)) dayCell.classList.add("selected");
      dayCell.onclick = () => { selectDate(date); };
      calendarGrid.appendChild(dayCell);
    });
  }

  function changeWeek(offset) {
    currentWeekStart.setDate(currentWeekStart.getDate() + offset * 7);
    // Assicurati che selectedDate sia all'interno della nuova settimana
    selectedDate = new Date(currentWeekStart); 
    renderCalendar();
    loadFormFromLocalStorage(); // Carica il luned√¨ della nuova settimana
  }

  function updateStatus(message, type = "info") {
    const statusElement = document.getElementById("status-message");
    if (!statusElement) return;
    statusElement.textContent = message;
    statusElement.className = "text-center text-sm mt-4 p-2 rounded-lg";
    statusElement.classList.remove("bg-green-100", "text-green-800", "bg-red-100", "text-red-800", "bg-blue-100", "text-blue-800");
    if (type === "success") statusElement.classList.add("bg-green-100", "text-green-800");
    else if (type === "error") statusElement.classList.add("bg-red-100", "text-red-800");
    else statusElement.classList.add("bg-blue-100", "text-blue-800");
  }

  function selectDate(date) {
    const oldSelected = document.querySelector('.calendar-day.selected');
    if (oldSelected) {
        oldSelected.classList.remove('selected');
    }

    selectedDate = date;
    
    const dateId = formatDateId(selectedDate);
    const newSelected = document.querySelector(`.calendar-day[data-date="${dateId}"]`);
    if (newSelected) {
        newSelected.classList.add('selected');
    }

    const dayOfWeekIndex = selectedDate.getDay(); // 0=Sun, 1=Mon...
    const dayName = dayNamesFull[dayOfWeekIndex];
    // Aggiorna la visualizzazione della data selezionata (SENZA ANNO)
    document.getElementById("selected-date-display").textContent =
      dayName + " " +
      selectedDate.getDate() + " " +
      monthNames[selectedDate.getMonth()];
      
    loadFormFromLocalStorage(); 
  }
  
  /**
   * Raccoglie i dati, convertendoli dal formato display (HH:MM) al formato di salvataggio (HHMM).
   */
  function collectDailyData() {
    const data = {};
    ["entrataMattina", "uscitaPranzo", "entrataPomeriggio", "uscitaSera"].forEach(field => {
        const input = document.getElementById(field).value.trim();
        data[field] = formatTimeInput(input); 
    });
    return data;
  }
  
  /**
   * Carica i dati dal Local Storage e li visualizza nella form.
   */
  function loadFormFromLocalStorage() {
    const dateId = formatDateId(selectedDate);
    const key = LOCAL_STORAGE_PREFIX + dateId;
    const dataString = localStorage.getItem(key);
    let dailyData = {};

    if (dataString) {
        try {
            dailyData = JSON.parse(dataString);
        } catch (e) {
            console.error("Errore nel parsing dei dati dal Local Storage per", dateId, e);
            dailyData = {};
        }
    }
    
    ["entrataMattina", "uscitaPranzo", "entrataPomeriggio", "uscitaSera"].forEach(field => {
      const input = document.getElementById(field);
      const storedHHMM = dailyData[field] || "0000";
      const displayValue = timeToDisplay(storedHHMM); 
      
      input.value = displayValue;
      
      if (storedHHMM === "0000") {
          input.classList.add('italic-placeholder');
      } else {
          input.classList.remove('italic-placeholder');
      }
    });

    updateDailyCalculations();
    updateStatus(`Dati per ${dateId} caricati.`, "info");
  }

  /**
   * Attacca i listener focus/blur/input per la formattazione HH:MM e i calcoli in tempo reale.
   */
  function addInputListeners() {
    document.querySelectorAll(".time-input").forEach(input => {
      // 1. INPUT: Aggiorna i calcoli in tempo reale
      input.addEventListener("input", updateDailyCalculations);
      
      // 2. FOCUS: Pulisce il campo
      input.addEventListener('focus', () => {
        let currentValue = input.value.replace(/:/g, '');
        if (currentValue === '0000' || currentValue === '000') {
             currentValue = ''; 
        }
        input.value = currentValue;
        input.classList.remove('italic-placeholder');
      });

      // 3. BLUR: Formatta in HH:MM e ricalcola
      input.addEventListener("blur", () => {
        const rawValue = input.value;
        const standardizedHHMM = formatTimeInput(rawValue);
        let displayValue = timeToDisplay(standardizedHHMM);
        
        if (standardizedHHMM === '0000') {
            displayValue = '00:00'; 
            input.classList.add('italic-placeholder');
        } else {
            input.classList.remove('italic-placeholder');
        }

        input.value = displayValue;
        updateDailyCalculations();
      });

    });
    document.getElementById("saveButton").onclick = saveDataToLocalStorage;
  }

  function attachSetTimeButtonListeners() {
    document.querySelectorAll('.set-time-btn').forEach(button => {
        button.addEventListener('click', () => {
            const targetId = button.dataset.target; 
            const inputField = document.getElementById(targetId);
            const currentTime = getCurrentFormattedTime();

            if (inputField) {
                inputField.value = currentTime;
                inputField.classList.remove('italic-placeholder');
                
                const event = new Event('blur');
                inputField.dispatchEvent(event);
                
                updateStatus(`Ora corrente (${currentTime}) impostata per ${targetId}.`, "success");
            }
        });
    });
  }

  /**
   * Salva i dati nel Local Storage.
   */
  function saveDataToLocalStorage() {
    const dateId = formatDateId(selectedDate);
    const key = LOCAL_STORAGE_PREFIX + dateId;
    const dataToSave = collectDailyData(); // Questo ritorna HHMM

    updateStatus("Salvataggio in corso...", "info");
    try {
      localStorage.setItem(key, JSON.stringify(dataToSave));
      updateStatus("Orario per la data selezionata salvato con successo nel Local Storage!", "success");
      
      // Aggiorna la cella del giorno sul calendario
      renderCalendar(); 

    } catch (e) {
      console.error("Errore nel salvataggio su Local Storage:", e);
      updateStatus("Errore nel salvataggio. Controlla la console.", "error");
    }
  }
  
  // =======================================================================
  // FUNZIONALIT√Ä ESPORTAZIONE EXCEL (.xlsx)
  // =======================================================================

  function dateIdToDate(dateId) {
    const parts = dateId.split('-');
    // Usiamo Date.UTC per evitare problemi di fuso orario quando si confrontano le date
    return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
  }
  
  function exportDataAsXLSX() {
    if (typeof XLSX === 'undefined') {
        updateStatus("Errore: La libreria SheetJS non √® stata caricata correttamente.", "error");
        return;
    }
    
    const startDateInput = document.getElementById("startDate").value;
    const endDateInput = document.getElementById("endDate").value;
    
    if (!startDateInput || !endDateInput) {
        updateStatus("Seleziona sia la data di inizio che quella di fine per l'esportazione.", "error");
        return;
    }

    const startDate = dateIdToDate(startDateInput);
    const endDate = dateIdToDate(endDateInput);

    if (startDate > endDate) {
        updateStatus("La data di fine non pu√≤ essere precedente alla data di inizio.", "error");
        return;
    }
    
    updateStatus("Preparazione dei dati per l'esportazione in Excel...", "info");

    const exportData = [];
    let dataFound = false;
    const inclusiveEndDate = new Date(endDate);
    inclusiveEndDate.setUTCDate(inclusiveEndDate.getUTCDate() + 1); // Rende l'intervallo inclusivo

    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        
        if (key && key.startsWith(LOCAL_STORAGE_PREFIX) && key.length === (LOCAL_STORAGE_PREFIX.length + 10)) {
            const dateId = key.substring(LOCAL_STORAGE_PREFIX.length);
            const date = dateIdToDate(dateId);

            if (date >= startDate && date < inclusiveEndDate) {
                const dataString = localStorage.getItem(key);
                try {
                    const data = JSON.parse(dataString);
                    const durations = calculateDurations(data); 

                    exportData.push({
                        "Data": dateId,
                        "Entrata Mattina (HH:MM)": timeToDisplay(data.entrataMattina || "0000"),
                        "Uscita Pranzo (HH:MM)": timeToDisplay(data.uscitaPranzo || "0000"),
                        "Entrata Pomeriggio (HH:MM)": timeToDisplay(data.entrataPomeriggio || "0000"),
                        "Uscita Sera (HH:MM)": timeToDisplay(data.uscitaSera || "0000"),
                        "Pausa Pranzo (HH:MM)": durations.breakDurationDisplay,
                        "Totale Ore Lavorate (HH:MM)": durations.totalHoursDisplay
                    });
                    
                    dataFound = true;
                    
                } catch (e) {
                    console.error("Errore di parsing JSON durante l'esportazione per la chiave:", key, e);
                }
            }
        }
    }
    
    if (!dataFound) {
        updateStatus("Nessun dato orario trovato nell'intervallo selezionato per l'esportazione in Excel.", "error");
        return;
    }

    const worksheet = XLSX.utils.json_to_sheet(exportData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "RapportoOrari"); 
    
    const filename = `orari_esportati_da_${startDateInput}_a_${endDateInput}.xlsx`;

    XLSX.writeFile(workbook, filename);
    
    updateStatus(`Esportazione completata! File Excel "${filename}" generato.`, "success");
  }

  function initializeExportInputs() {
      const today = formatDateId(new Date());
      document.getElementById('endDate').value = today; 
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      document.getElementById('startDate').value = formatDateId(thirtyDaysAgo);
      
      document.getElementById("exportButton").onclick = exportDataAsXLSX;
  }


  window.onload = function () {
    // Navigazione Settimanale
    document.getElementById("prevWeek").onclick = () => changeWeek(-1);
    document.getElementById("nextWeek").onclick = () => changeWeek(1);

    // Selezione iniziale e rendering
    // Assicura che la data selezionata cada su un giorno lavorativo della settimana corrente
    let today = new Date();
    if (today.getDay() === 0 || today.getDay() === 6) { // Se √® Sabato (6) o Domenica (0), seleziona il Luned√¨
        selectedDate = getStartOfWeek(today);
    } else {
        selectedDate = today;
    }
    currentWeekStart = getStartOfWeek(selectedDate);
    
    updateStatus("Applicazione inizializzata. Dati salvati in Local Storage.");
    renderCalendar();
    selectDate(selectedDate);
    addInputListeners();
    initializeExportInputs();
    attachSetTimeButtonListeners();
  };
</script>

</body>
</html>